<!DOCTYPE html>
<html lang="fa" dir="rtl">
<link rel="icon" href="data:,">
<head>
<meta charset="UTF-8">
<title>Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap');
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#c9d6ff,#e2e2e2,#d8bfd8); min-height:100vh; display:flex; align-items:center; justify-content:center; margin:0; color:#333; }
.container { background:#ffffffcc; padding:30px; border-radius:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:520px; text-align:center; }
button { background:linear-gradient(90deg,#7aa2f7,#b388eb); color:white; border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { transform:scale(1.05); }
.hidden { display:none; }
.role-buttons { display:flex; justify-content:space-around; margin:15px 0; }
input { padding:10px; border-radius:8px; border:1px solid #aaa; width:80%; margin:10px 0; text-align:center; }
.exam-card { background:#f5f5ff; border:2px solid #d0c4f7; border-radius:15px; padding:15px; margin:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.exam-card h3 { color:#4a47a3; margin-bottom:10px; }
.qnum { background:#d0c4f7; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; margin:3px; }
.qnum.active { background:#7aa2f7; color:white; }
.option { display:block; background:#fff; border:1px solid #ccc; padding:8px; margin:8px auto; border-radius:10px; cursor:pointer; width:90%; transition:0.2s; }
.option:hover { background:#e9e9ff; }
#timer { font-size:18px; font-weight:bold; color:#4a47a3; margin:10px; }
#question-box img { width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); margin-bottom:10px; }
.result-table { width:100%; border-collapse:collapse; margin-top:15px; }
.result-table th, .result-table td { border:1px solid #aaa; padding:8px; }
.result-table th { background:#eaeaff; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
.empty { color:#777; font-weight:bold; }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container" id="login-section">
  <h1>ğŸ“  Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</h1>
  <p>Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
  <div class="role-buttons">
    <button id="student-btn">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
    <button id="teacher-btn">Ù…Ø´Ø§ÙˆØ±</button>
  </div>

  <div id="student-form" class="hidden">
    <input type="text" id="student-name" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button id="student-enter">ÙˆØ±ÙˆØ¯</button>
  </div>

  <div id="teacher-form" class="hidden">
    <input type="password" id="teacher-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button id="teacher-enter">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<div class="container hidden" id="exam-list">
  <h2>ğŸ“ Ø¢Ø²Ù…ÙˆÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
  <div id="exam-container"></div>
</div>

<div class="container hidden" id="exam-section">
  <h2 id="exam-title"></h2>
  <div id="timer"></div>
  <div id="question-box"></div>
  <div>
    <button id="prev-btn">âŸ¨ Ù‚Ø¨Ù„ÛŒ</button>
    <button id="next-btn">Ø¨Ø¹Ø¯ÛŒ âŸ©</button>
  </div>
  <div id="question-list" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
  <br>
  <button id="finish-btn">Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ†</button>
</div>

<div class="container hidden" id="result-section">
  <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¢Ø²Ù…ÙˆÙ†</h2>
  <div id="score-summary"></div>
  <table class="result-table">
    <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø¤Ø§Ù„</th><th>Ù¾Ø§Ø³Ø® Ø´Ù…Ø§</th><th>Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead>
    <tbody id="result-body"></tbody>
  </table>
  <br>
  <a id="answerkey-link" href="#" download><button>ğŸ“˜ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø§Ø³Ø®â€ŒÙ†Ø§Ù…Ù‡</button></a>
</div>

<div class="container hidden" id="teacher-panel">
  <h2>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h2>
  <table id="results-table" style="width:100%; border-collapse:collapse;">
    <thead><tr><th>Ù†Ø§Ù…</th><th>Ø¢Ø²Ù…ÙˆÙ†</th><th>Ø¯Ø±ØµØ¯</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const teacherPassword = "mm2hakdkcnks";
const exams = ["physics", "11-1-r"];

let selectedExam = null, currentQuestion = 0, answers = [], timerInterval, remainingTime, studentName = "";

// Ù†Ù‚Ø´â€ŒÙ‡Ø§
document.getElementById("student-btn").onclick = () => {
  document.getElementById("student-form").classList.remove("hidden");
  document.getElementById("teacher-form").classList.add("hidden");
};
document.getElementById("teacher-btn").onclick = () => {
  document.getElementById("teacher-form").classList.remove("hidden");
  document.getElementById("student-form").classList.add("hidden");
};

// ÙˆØ±ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
document.getElementById("student-enter").onclick = () => {
  studentName = document.getElementById("student-name").value.trim();
  if (!studentName) return alert("Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  document.getElementById("login-section").classList.add("hidden");
  const cont = document.getElementById("exam-container");
  cont.innerHTML = "";
  exams.forEach((name) => {
    const div = document.createElement("div");
    div.className = "exam-card";
    div.innerHTML = `<h3>${name}</h3><button onclick="startExam('${name}')">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>`;
    cont.appendChild(div);
  });
  document.getElementById("exam-list").classList.remove("hidden");
};

// ÙˆØ±ÙˆØ¯ Ù…Ø¹Ù„Ù…
document.getElementById("teacher-enter").onclick = () => {
  if (document.getElementById("teacher-pass").value === teacherPassword) showTeacherPanel();
  else alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
};

// Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† (Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¢Ø²Ù…ÙˆÙ† Ø§Ø² Upload.ir Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§)
window.startExam = function (examName) {
  selectedExam = examName;
  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("exam-section").classList.remove("hidden");
  document.getElementById("exam-title").innerText = "Ø¢Ø²Ù…ÙˆÙ† " + examName;
  // GitHub raw links for ZIP files:
  const zipLinks = {
    "physics": "https://raw.githubusercontent.com/test111account/exam/main/physics.zip",
    "11-1-r": "https://raw.githubusercontent.com/test111account/exam/main/11-1-r.zip"
  };
  const zipUrl = zipLinks[examName];
  if (!zipUrl) {
    alert("Ù„ÛŒÙ†Ú© Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯!");
    return;
  }
  fetchAndLoadExamZip(zipUrl, examName);
};

// Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ JSZip (Ø¨Ø§ fetch Ùˆ CORS)
async function fetchAndLoadExamZip(zipUrl, examName) {
  try {
    // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¨Ø§ fetch Ùˆ blob (CORS-safe)
    const resp = await fetch(zipUrl, { mode: 'cors' });
    if (!resp.ok) throw new Error("Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.");
    const zipBlob = await resp.blob();
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø§ JSZip
    const jszip = window.JSZip;
    const zipData = await zipBlob.arrayBuffer();
    const zip = await jszip.loadAsync(zipData);

    // Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ†
    let duration = 300;
    if (zip.file("time.txt")) {
      const timeText = await zip.file("time.txt").async("string");
      duration = parseInt(timeText.trim()) || 300;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³ÙˆØ§Ù„Ø§Øª: Ù‡Ø± Ø³ÙˆØ§Ù„ ÛŒÚ© Ø¹Ú©Ø³ Ø¨Ù‡ ØµÙˆØ±Øª 1-1.jpg ÛŒØ§ 1-1.png ... 50-4.jpg/pngØŒ Ú¯Ø²ÛŒÙ†Ù‡ ØµØ­ÛŒØ­ Ø§ÙˆÙ„ÛŒÙ† Ø¹Ú©Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
    const imgList = [];
    for (let i = 1; i <= 50; i++) {
      let found = false;
      for (let j = 1; j <= 4; j++) {
        const exts = ["jpg", "png"];
        for (const ext of exts) {
          const fname = `${i}-${j}.${ext}`;
          const fileObj = zip.file(fname);
          if (fileObj) {
            const blob = await fileObj.async("blob");
            const url = URL.createObjectURL(blob);
            imgList.push({ id: i, src: url, correct: j });
            found = true;
            break;
          }
        }
        if (found) break;
      }
      if (!found) break;
    }
    if (imgList.length === 0) {
      alert("Ù‡ÛŒÚ† ØªØµÙˆÛŒØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø²ÛŒÙ¾ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
      return;
    }
    // Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ PDF
    let answerkeyPdfUrl = "#";
    if (zip.file("answerkey.pdf")) {
      const pdfBlob = await zip.file("answerkey.pdf").async("blob");
      answerkeyPdfUrl = URL.createObjectURL(pdfBlob);
    }
    showExam(imgList, duration, examName, answerkeyPdfUrl);
  } catch (e) {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¢Ø²Ù…ÙˆÙ†");
    console.error(e);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†
function showExam(questions, duration, folder, answerkeyPdfUrl) {
  selectedExam = { folder, questions, duration_sec: duration, answerkeyPdfUrl };
  answers = new Array(questions.length).fill(null);
  currentQuestion = 0;
  renderQuestion();
  renderQList();
  startTimer(duration);
  document.getElementById("prev-btn").style.display = "";
  document.getElementById("next-btn").style.display = "";
  document.getElementById("finish-btn").style.display = "";
  document.getElementById("question-list").style.display = "flex";
}

// Ù†Ù…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„
function renderQuestion() {
  const q = selectedExam.questions[currentQuestion];
  const box = document.getElementById("question-box");
  box.innerHTML = `<img src="${q.src}" alt="question">`;
  for (let i = 1; i <= 4; i++) {
    const div = document.createElement("div");
    div.className = "option";
    if (answers[currentQuestion] === i) div.style.background = "#d0c4f7";
    div.innerText = `Ú¯Ø²ÛŒÙ†Ù‡ ${i}`;
    div.onclick = () => {
      if (answers[currentQuestion] === i) {
        answers[currentQuestion] = null; // Deselect if the same option is clicked
      } else {
        answers[currentQuestion] = i; // Select new option
      }
      renderQuestion();
      renderQList();
    };
    box.appendChild(div);
  }
  document.querySelectorAll(".qnum").forEach((e, i) => { e.classList.toggle("active", i === currentQuestion); });
}

// Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„Ø§Øª
document.getElementById("next-btn").onclick = () => { if (currentQuestion < selectedExam.questions.length - 1) { currentQuestion++; renderQuestion(); } };
document.getElementById("prev-btn").onclick = () => { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } };

// Ù„ÛŒØ³Øª Ø³Ø¤Ø§Ù„Ø§Øª Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡
function renderQList() {
  const list = document.getElementById("question-list"); list.innerHTML = "";
  selectedExam.questions.forEach((_, i) => {
    const b = document.createElement("div");
    b.className = "qnum"; b.innerText = i + 1;
    if (answers[i] != null) b.style.opacity = "1";
    b.onclick = () => { currentQuestion = i; renderQuestion(); };
    list.appendChild(b);
  });
}

// ØªØ§ÛŒÙ…Ø±
function startTimer(sec) {
  remainingTime = sec;
  const timer = document.getElementById("timer");
  timerInterval = setInterval(() => {
    remainingTime--;
    const m = Math.floor(remainingTime / 60), s = remainingTime % 60;
    timer.innerText = `â° ${m}:${s.toString().padStart(2, '0')}`;
    if (remainingTime <= 0) { clearInterval(timerInterval); finishExam(); }
  }, 1000);
}

document.getElementById("finish-btn").onclick = finishExam;

// Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ (Supabase Only, Ø±ØªØ¨Ù‡ Ùˆ ØªØ±Ø§Ø² ØµØ­ÛŒØ­ Ø¨Ø§ Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ)
async function finishExam() {
  clearInterval(timerInterval);

  let correct = 0, wrong = 0, empty = 0;
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    if (ans == null) empty++;
    else if (ans === q.correct) correct++;
    else wrong++;
  });

  // Ù†Ù…Ø±Ù‡ Ø¨Ø§ Ù…Ù†ÙÛŒ
  const rawScore = correct - wrong / 3;
  const totalQuestions = selectedExam.questions.length;
  const percentScore = (rawScore / totalQuestions) * 100;

  // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  let allScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, score, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allScores = data.map(r => ({ name: r.name, score: r.score, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ùˆ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø± Ø¯Ø±ØµØ¯Ù‡Ø§
  const percentList = allScores.map(r => Number(r.score)).filter(x => !isNaN(x));
  percentList.push(percentScore); // Ø¯Ø±ØµØ¯ ÙØ¹Ù„ÛŒ Ø±Ø§ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† (ØªØ§ Ø¯Ø± Ø¬Ù…Ø¹ Ù„Ø­Ø§Ø¸ Ø´ÙˆØ¯)
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
  const mean = percentList.length > 0 ? percentList.reduce((a, b) => a + b, 0) / percentList.length : 50;
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø±
  let stdDev = 10;
  if (percentList.length > 1) {
    const variance = percentList.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / percentList.length;
    stdDev = Math.sqrt(variance);
    // Ø§Ú¯Ø± stdDev Ø®ÛŒÙ„ÛŒ Ú©Ù… Ø´Ø¯ØŒ Ø­Ø¯Ø§Ù‚Ù„ 5 Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ØªØ§ ØªØ±Ø§Ø² Ù…Ø¹Ù†Ø§Ø¯Ø§Ø± Ø¨Ù…Ø§Ù†Ø¯
    if (stdDev < 5) stdDev = 5;
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  const tScore = 5000 + 1000 * (percentScore - mean) / stdDev;

  // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ÙØ¹Ù„ÛŒ Ø¯Ø± Supabase
  try {
    await supabase
      .from('exam_results')
      .insert([{
        name: studentName,
        exam: selectedExam.folder,
        score: percentScore,
        tScore: tScore,
        created_at: new Date().toISOString() // ensure timestamp is set
      }]);
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡:", error);
  }

  // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬Ø¯Ø¯ Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
  let allTScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allTScores = data.map(r => ({ name: r.name, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ:
  // 1. Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø±Ø§ Ù†Ø²ÙˆÙ„ÛŒ Ù…Ø±ØªØ¨ Ú©Ù†
  // 2. Ø±ØªØ¨Ù‡ Ù‡Ø± ØªØ±Ø§Ø² Ø±Ø§ Ø¯Ø± ÛŒÚ© Map Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
  // 3. Ø±ØªØ¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² = Ù…Ù‚Ø¯Ø§Ø± Map Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ø² Ø®ÙˆØ¯Ø´
  const tScoresSorted = allTScores
    .map(r => Number(r.tScore))
    .filter(x => !isNaN(x));
  tScoresSorted.sort((a, b) => b - a);
  const tScoreToRank = new Map();
  let rank = 1;
  for (let i = 0; i < tScoresSorted.length; i++) {
    const ts = tScoresSorted[i];
    if (!tScoreToRank.has(ts)) {
      tScoreToRank.set(ts, rank);
      rank++;
    }
  }
  const myRank = tScoreToRank.has(tScore) ? tScoreToRank.get(tScore) : tScoresSorted.length;
  const totalParticipants = tScoresSorted.length;

  // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.remove("hidden");

  document.getElementById("score-summary").innerHTML = `
    <p>ğŸ¯ Ø¯Ø±ØµØ¯ Ù†Ù…Ø±Ù‡: <b>${percentScore.toFixed(2)}%</b></p>
    <p>ğŸ“Š ØªØ±Ø§Ø²: <b>${tScore.toFixed(2)}</b></p>
    <p>ğŸ† Ø±ØªØ¨Ù‡: Ù†ÙØ± <b>${myRank}</b> Ø§Ø² <b>${totalParticipants}</b> Ù†ÙØ±</p>
    <p>âœ… Ø¯Ø±Ø³Øª: ${correct} | âŒ ØºÙ„Ø·: ${wrong} | âº Ù†Ø²Ø¯Ù‡: ${empty}</p>
  `;

  const tbody = document.getElementById("result-body");
  tbody.innerHTML = "";
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    let statusClass = "", statusText = "";
    if (ans == null) { statusClass = "empty"; statusText = "Ù†Ø²Ø¯Ù‡"; }
    else if (ans === q.correct) { statusClass = "correct"; statusText = "Ø¯Ø±Ø³Øª"; }
    else { statusClass = "wrong"; statusText = "ØºÙ„Ø·"; }

    const row = `<tr>
      <td>${i + 1}</td>
      <td>${ans ? ans : "-"}</td>
      <td>${q.correct}</td>
      <td class="${statusClass}">${statusText}</td>
    </tr>`;
    tbody.innerHTML += row;
  });

  // Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ PDF
  const link = document.getElementById("answerkey-link");
  if (selectedExam.answerkeyPdfUrl) {
    link.href = selectedExam.answerkeyPdfUrl;
    link.download = "answerkey.pdf";
  } else {
    link.href = "#";
    link.download = "";
  }

  // ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± PDF Ø§Ø² Ø¨Ø®Ø´ Ù†ØªÛŒØ¬Ù‡ Ù¾Ø³ Ø§Ø² Ù†Ù…Ø§ÛŒØ´
  setTimeout(async () => {
      try {
          const resultSection = document.getElementById("result-section");
          const canvas = await html2canvas(resultSection, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jspdf.jsPDF({
              orientation: "portrait",
              unit: "pt",
              format: "a4"
          });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = pageWidth - 40;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          pdf.addImage(imgData, "PNG", 20, 20, imgWidth, imgHeight);
          pdf.save(`Ú¯Ø²Ø§Ø±Ø´_Ø¢Ø²Ù…ÙˆÙ†_${studentName}.pdf`);
      } catch (e) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF:", e);
      }
  }, 1000);
}

// Ø­Ø°Ù Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± localStorage (Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù… (Supabase)
function showTeacherPanel() {
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("teacher-panel").classList.remove("hidden");
  loadTeacherResults();
}

// Ù„ÙˆØ¯ Ù†ØªØ§ÛŒØ¬ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø§Ø² Supabase Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø«Ø¨Øª Ùˆ Ø³ØªÙˆÙ† ØªØ±Ø§Ø²
async function loadTeacherResults() {
  const tbody = document.querySelector("#teacher-panel tbody");
  tbody.innerHTML = "";
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, exam, score, tScore, created_at');
    // Debug: Print all received data and error
    console.log("Supabase data received:", data, "Error:", error);
    if (error) throw error;

    data.forEach(r => {
        // Debug: Print each record to inspect column names and values
        console.log("Record:", r); // Print each record to inspect column names and values

        let dateStr = "-";
        // Fallback: check for created_at property
        if (r.created_at) { // fallback check
            try {
                const d = new Date(r.created_at);
                if (!isNaN(d)) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hour = String(d.getHours()).padStart(2, '0');
                    const min = String(d.getMinutes()).padStart(2, '0');
                    dateStr = `${y}/${m}/${day} ${hour}:${min}`;
                }
            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:", e);
            }
        }

        const scoreDisplay = r.score != null ? r.score.toFixed(2) : "-";
        const tScoreDisplay = r.tScore != null ? r.tScore.toFixed(2) : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${r.name}</td>
            <td>${r.exam}</td>
            <td>${scoreDisplay}%<br><span style="font-size:11px;color:#666">ØªØ±Ø§Ø²: ${tScoreDisplay}</span></td>
            <td>${dateStr}</td>
        `;
        tbody.appendChild(row);
    });
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬</td></tr>`;
    console.error(e);
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://egiufeahskfobwhmdbqy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaXVmZWFoc2tmb2J3aG1kYnF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDgzMDksImV4cCI6MjA3NzA4NDMwOX0.3w7G0w5ukLh2B6KU1wfuJJFfOa_HhhGoLFuwUlzSXGw";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</body>
</html>
