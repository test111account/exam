<!DOCTYPE html>
<html lang="fa" dir="rtl">
<link rel="icon" href="data:,">
<head>
<meta charset="UTF-8">
<title>Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap');
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#c9d6ff,#e2e2e2,#d8bfd8); min-height:100vh; display:flex; align-items:center; justify-content:center; margin:0; color:#333; }
.container { background:#ffffffcc; padding:30px; border-radius:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:650px; text-align:center; }
#exam-section.container {
    width: 90% !important;
    max-width: 900px;
}
button { background:linear-gradient(90deg,#7aa2f7,#b388eb); color:white; border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { transform:scale(1.05); }
.hidden { display:none; }
.role-buttons { display:flex; justify-content:space-around; margin:15px 0; }
input { padding:10px; border-radius:8px; border:1px solid #aaa; width:80%; margin:10px 0; text-align:center; }
.exam-card { background:#f5f5ff; border:2px solid #d0c4f7; border-radius:15px; padding:15px; margin:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.exam-card h3 { color:#4a47a3; margin-bottom:10px; }
.qnum { background:#d0c4f7; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; margin:3px; }
.qnum.active { background:#7aa2f7; color:white; }
.qnum.answered {
    border: 3px solid #7aa2f7;
    background: #eef2ff;
}
.qnum.unanswered {
    opacity: 0.4;
}
.option { display:block; background:#fff; border:1px solid #ccc; padding:8px; margin:8px auto; border-radius:10px; cursor:pointer; width:90%; transition:0.2s; }
.option:hover { background:#e9e9ff; }
#timer { font-size:18px; font-weight:bold; color:#4a47a3; margin:10px; }
#question-box img { width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); margin-bottom:10px; }
.result-table { width:100%; border-collapse:collapse; margin-top:15px; }
.result-table th, .result-table td { border:1px solid #aaa; padding:8px; }
.result-table th { background:#eaeaff; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
.empty { color:#777; font-weight:bold; }
.exam-btn-selected {
    background:#4a6cf7 !important;
    color:white !important;
    border:2px solid #2b4ad8 !important;
}

/* Teacher panel table styling */
#results-table th, #results-table td {
    padding: 6px 8px;
    text-align: center;
    vertical-align: middle;
}

#results-table {
    border-spacing: 0 2px;
}

</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; color:white; display:none; align-items:center; justify-content:center; flex-direction:column; font-size:22px; z-index:9999;">
    <div id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯... 0%</div>
    <div style="width:60%; background:#fff3; height:10px; border-radius:5px; margin-top:10px;">
        <div id="loading-bar" style="width:0%; height:100%; background:#7aa2f7; border-radius:5px;"></div>
    </div>
    <div style="margin-top:12px; font-size:16px;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</div>
</div>

<body>

<div class="container" id="login-section">
  <h1>ğŸ“  Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</h1>
  <p>Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
  <div class="role-buttons">
    <button id="student-btn">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
    <button id="admin-btn">Ù¾Ù†Ù„ Ù…Ø¹Ø±Ø§Ø¬</button>
    <button id="advisor-btn">Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±</button>
  </div>

  <div id="student-form" class="hidden">
    <input type="text" id="student-name" placeholder="Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="text" id="paye" placeholder="Ù¾Ø§ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="text" id="reshte" placeholder="Ø±Ø´ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button id="student-enter">ÙˆØ±ÙˆØ¯</button>
  </div>

  <div id="admin-form" class="hidden">
    <input type="password" id="admin-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¹Ø±Ø§Ø¬">
    <button id="admin-enter">ÙˆØ±ÙˆØ¯</button>
  </div>

<div id="advisor-form" class="hidden">
    <!-- Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ù… Ù…Ø´Ø§ÙˆØ±ØŒ ÙÙ‚Ø· Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± -->
    <input type="password" id="advisor-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø´Ø§ÙˆØ±">
    <button id="advisor-enter">ÙˆØ±ÙˆØ¯</button>
</div>
</div>

<div class="container hidden" id="exam-list">
  <h2>ğŸ“ Ø¢Ø²Ù…ÙˆÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
  <div id="exam-container"></div>
</div>

<div class="container hidden" id="exam-section">
  <h2 id="exam-title"></h2>
  <div id="timer"></div>
  <div id="question-box"></div>
  <div>
    <button id="prev-btn">âŸ¨ Ù‚Ø¨Ù„ÛŒ</button>
    <button id="next-btn">Ø¨Ø¹Ø¯ÛŒ âŸ©</button>
  </div>
  <div id="question-list" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
  <br>
  <button id="finish-btn">Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ†</button>
</div>

<div class="container hidden" id="result-section">
  <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¢Ø²Ù…ÙˆÙ†</h2>
  <div id="score-summary"></div>
  <table class="result-table">
    <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø¤Ø§Ù„</th><th>Ù¾Ø§Ø³Ø® Ø´Ù…Ø§</th><th>Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead>
    <tbody id="result-body"></tbody>
  </table>
  <br>
</div>

<div class="container hidden" id="teacher-panel">
  <h2 id="teacher-panel-title">ğŸ“Š Ù¾Ù†Ù„ Ù…Ø¹Ø±Ø§Ø¬</h2>
  <div style="display:flex;justify-content:center;gap:12px;margin-bottom:18px;flex-wrap:wrap;">
    <button id="teacher-tab-exam" class="teacher-tab-btn exam-btn-selected">Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ø²Ù…ÙˆÙ†</button>
    <button id="teacher-tab-student" class="teacher-tab-btn">Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
    <button id="teacher-tab-advisor-scores" class="teacher-tab-btn">Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡Ø§</button>
    <button id="teacher-tab-student-scores" class="teacher-tab-btn">Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</button>
  </div>
  <div id="teacher-panel-exam-section">
    <h3>ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</h3>
    <div id="teacher-exam-list"></div>
    <br>
    <button id="download-excel" style="margin-bottom:10px;">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„</button>
    <table id="results-table" class="hidden" style="width:100%; border-collapse:collapse;">
      <thead>
      <tr>
      <th>Ø±ØªØ¨Ù‡</th>
      <th>Ù†Ø§Ù…</th>
      <th>Ø¯Ø±ØµØ¯</th>
      <th>ØªØ±Ø§Ø²</th>
      <th>ØªØ§Ø±ÛŒØ®</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="teacher-panel-student-section" class="hidden">
    <h3>ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</h3>
    <div id="teacher-student-list" style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px 16px;max-height:220px;overflow-y:auto;margin-bottom:12px;"></div>
    <div id="teacher-student-selected-name" style="font-weight:bold;margin-bottom:8px;"></div>
    <table id="student-results-table" class="hidden" style="width:100%; border-collapse:collapse;">
      <thead>
      <tr>
      <th>Ø¢Ø²Ù…ÙˆÙ†</th>
      <th>Ø¯Ø±ØµØ¯</th>
      <th>ØªØ±Ø§Ø²</th>
      <th>ØªØ§Ø±ÛŒØ®</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="teacher-panel-advisor-scores-section" class="hidden">
    <h3>Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡Ø§ (Ø¬Ù…Ø¹ ØªØ±Ø§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†)</h3>
    <div id="advisor-scores-table-wrap"></div>
  </div>
  <div id="teacher-panel-student-scores-section" class="hidden">
    <h3>Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† (Ø¬Ù…Ø¹ ØªØ±Ø§Ø²)</h3>
    <div id="student-scores-table-wrap"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const teacherPassword = "mm2hakdkcnks";
const exams = ["shimi_14dey"];

const examTimes = {
  "shimi_14dey": {
    start: new Date("2026-01-04T00:00:00Z"),
    end: new Date("2026-01-07T23:59:59Z")
  }
};

let selectedExam = null, currentQuestion = 0, answers = [], timerInterval, remainingTime, studentName = "";

// Ù†Ù‚Ø´â€ŒÙ‡Ø§
document.getElementById("student-btn").onclick = () => {
  document.getElementById("student-form").classList.remove("hidden");
  document.getElementById("admin-form").classList.add("hidden");
  document.getElementById("advisor-form").classList.add("hidden");
};
document.getElementById("admin-btn").onclick = () => {
  document.getElementById("admin-form").classList.remove("hidden");
  document.getElementById("student-form").classList.add("hidden");
  document.getElementById("advisor-form").classList.add("hidden");
};
document.getElementById("advisor-btn").onclick = () => {
  document.getElementById("advisor-form").classList.remove("hidden");
  document.getElementById("student-form").classList.add("hidden");
  document.getElementById("admin-form").classList.add("hidden");
};
/* =========================
   ØªØ¹Ø±ÛŒÙ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ùˆ Ø±Ù…Ø²Ù‡Ø§
   ========================= */
// ØªØ¹Ø±ÛŒÙ studentPasswords Ø¨Ø§ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯!
const studentPasswords = {
  "Edu01A": { name: "Ù…Ø­Ù…Ø¯ Ø­Ø³ÛŒÙ† Ù…ÙˆÛŒØ¯ÛŒ", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu02B": { name: "Ù‡Ø³ØªÛŒ Ù†Ø§ØµØ±ÛŒ", advisor: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹" },
  "Edu03C": { name: "Ø³ÛŒØ¯Ù‡ Ù…Ø¯ÛŒÙ†Ù‡ Ø¯Ø§Ù†ÛŒØ§Ù„ÛŒ", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu04D": { name: "ÙØ§Ø·ÛŒÙ…Ø§ Ø§Ø³Ù„Ø§Ù…ÛŒ", advisor: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹" },
  "Edu05E": { name: "Ø³ØªØ§Ø±Ù‡ Ø´Ø§Ø·Ø±ÛŒ", advisor: "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ" },
  "Edu06F": { name: "Ø³ÙˆÛŒÙ„ Ø§Ø³Ù…Ø§Ø¹ÛŒÙ„ Ø²Ø§Ø¯Ù‡", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu07G": { name: "Ù…Ø¹ØµÙˆÙ…Ù‡ Ù‚Ø§Ø³Ù… Ù¾ÙˆØ±", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu08H": { name: "Ø³ÛŒØ¯Ù‡ Ø±ÛŒØ­Ø§Ù†Ù‡ Ø³ÛŒØ¯ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu09J": { name: "Ù…Ú˜Ø¯Ù‡ ÛŒÙˆØ³ÙÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu10K": { name: "ÛŒØ§Ø³Ù…Ù† Ø¯Ù„ÙØ§Ù†", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu11L": { name: "ÙØ§Ø·Ù…Ù‡ Ù¾ÙˆØ±Ø¸ÙØ±", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu12M": { name: "ÙÛŒØ±ÙˆØ²Ù‡ Ù‚Ø¨Ø§", advisor: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹" },
  "Edu13N": { name: "Ø¢Ù†ÛŒØªØ§ Ø¨Ø§Ù‚Ø±ÛŒ", advisor: "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ" },
  "Edu14P": { name: "Ø³ÛŒØ¯ Ù…ÛŒØ«Ù… Ù…ÙˆÙ…Ù† Ù‚Ø²ÙˆÛŒÙ†ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu15Q": { name: "Ø³Ù†Ø§ Ø¬Ø§Ù†Ø¨Ø§Ø²", advisor: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹" },
  "Edu17S": { name: "Ø¹Ù„ÛŒ ØµØ¯ÛŒÙ‚ÛŒØ§Ù†", advisor: "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ" },
  "Edu18T": { name: "Ø¢Ø±Ø§Ù† Ø´ÛŒØ® Ø§Ø³Ù„Ø§Ù…ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu19U": { name: "Ù…Ù„ÛŒÚ©Ø§ Ø¹Ù„ÙˆÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu20V": { name: "ÙØ§Ø·Ù…Ù‡ Ø­Ø³ÛŒÙ†Ø²Ø§Ø¯Ù‡", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu21W": { name: "ÙØ§Ø·Ù…Ù‡ Ø­ÛŒØ¯Ø±ÛŒ", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu22X": { name: "Ø¹Ù„ÛŒ Ø¨Ø±Ø§Ø±ÛŒ", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu23Y": { name: "Ø´Ù‚Ø§ÛŒÙ‚ Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu24Z": { name: "ØºØ²Ù„ Ø­Ø³ÛŒÙ†ÛŒ", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu25A": { name: "Ù…Ù‡Ø³Ø§ Ù…Ø±Ø§Ø¯ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu26B": { name: "Ú©Ù…Ù†Ø¯ Ø§Ø³Ú©Ù†Ø¯Ø±ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu27C": { name: "Ø²Ù‡Ø±Ø§ Ù…Ù†Ø§ØªÛŒ", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu28D": { name: "Ù†Ø§Ø²Ù†ÛŒÙ† Ù†ÛŒÚ© Ø±ÙˆØ´", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu29E": { name: "Ù¾Ø±ÛŒØ§ Ù†Ø±Ø§Ù‚ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu30F": { name: "Ù¾Ø±Ù†ÛŒØ§ Ù†Ø±Ø§Ù‚ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu31G": { name: "Ø³ØªØ§ÛŒØ´ Ù…Ø±Ø§Ø¯ÛŒ", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu32H": { name: "Ù…Ø­Ù…Ø¯ Ù…Ù‡Ø¯ÛŒ Ø·Ø§Ù‡Ø±ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu33J": { name: "Ø¹Ø±ÙØ§Ù† Ø±Ø´ÛŒØ¯ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu34K": { name: "Ø¢Ø±ÛŒØ§Ù†Ø§ Ù…ÛŒØ±Ø²Ø§Ø¯Ù‡", advisor: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹" },
  "Edu35L": { name: "ÙØ±Ø¯ÙˆØ³ Ø¯ØºØ§ØºÙ„Ù‡", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu36M": { name: "ÙØ§Ø·Ù…Ù‡ Ù…ÙˆØ³ÛŒ Ù¾ÙˆØ±", advisor: "Ø²Ù‡Ø±Ø§ Ù†ÙØ³" },
  "Edu37N": { name: "Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ú†Ø±Ø§ØºÛŒØ§Ù†", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu38P": { name: "Ù…Ø±ÛŒÙ… Ø­ÛŒØ¯Ø±ÛŒ", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu39Q": { name: "Ø±ÛŒØ­Ø§Ù†Ù‡ Ù¾Ù†Ø§Ù‡ÛŒ", advisor: "Ù†Ú¯ÛŒÙ† Ù…Ù‡Ø§Ø¬Ø±" },
  "Edu40R": { name: "Ù‡Ø³ØªÛŒ Ø¨Ø®Ø´ÛŒØ¯Ù‡", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu41S": { name: "Ú©Ø¨Ø§Ù†Ø§ Ø¹Ø·Ø§Ø§ÙØ±ÛŒÙ†", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu42T": { name: "Ù…Ù„ÛŒÚ©Ø§ Ø­Ø³ÛŒÙ†ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu43U": { name: "Ø¹Ø§Ø±ÙÙ‡ Ø¬Ø§Ù† Ù†Ø«Ø§Ø±", advisor: "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ" },
  "Edu44V": { name: "Ù‡Ù„Ù†Ø§ Ø§Ù„Ù…Ø§Ø³ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu45W": { name: "ÛŒØ§Ø³Ù…ÛŒÙ† Ø§Ù†ØµØ§Ø±ÛŒ", advisor: "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ" },
  "Edu46X": { name: "Ø³Ù…Ø§Ù†Ù‡ Ø´Ø¹Ø¨Ø§Ù†ÛŒ", advisor: "ÙØ§Ø·Ù…Ù‡ Ø²Ù‡Ø±Ø§ Ú©ÙˆØ´Ú©ÛŒ" },
  "Edu47Y": { name: "Ø­Ø¯ÛŒØ« Ø®Ø²Ø§ÛŒÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu48Z": { name: "Ø²Ù‡Ø±Ø§ Ø¬ØºØªØ§ÛŒÛŒ", advisor: "ÙØ§Ø·Ù…Ù‡ Ø²Ù‡Ø±Ø§ Ú©ÙˆØ´Ú©ÛŒ" },
  "Edu49A": { name: "Ø¢Ø±Ø´ Ø¨Ø®Ø´ÛŒ", advisor: "Ø­Ù†Ø§Ù†Ù‡ Ø­Ø³Ù† Ø²Ø§Ø¯Ù‡" },
  "Edu50B": { name: "Ú©ÛŒØ§Ù†Ø§Ø² ØµÙ…Ø¯ÛŒ", advisor: "Ù†Ú¯ÛŒÙ† Ù…Ù‡Ø§Ø¬Ø±" },
  "Edu51C": { name: "Ù…Ù„ÛŒÚ©Ø§ Ø±ÛŒÙˆÙ Ù¾Ù†Ø§Ù‡", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu52D": { name: "Ù…Ù„ÛŒÙ†Ø§ Ø§Ú©Ø¨Ø±ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu53E": { name: "Ø³ØªØ§ÛŒØ´ Ø³ØªÙˆØ¯Ù‡", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu54F": { name: "Ù…Ø¨ÛŒÙ†Ø§ Ø¨Ø®Ø´ÛŒ Ù¾ÙˆØ±", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu55G": { name: "Ø³Ø§ÛŒÙ†Ø§ Ù…ØµØ·ÙØ§ÛŒÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu56H": { name: "Ù…Ø·Ù‡Ø±Ù‡  Ø¢Ø°Ø±ÛŒØ§Ù†", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu57J": { name: "Ø±Ø§ÙˆÚ© Ø´Ø¹Ù„Ø¨Ø§Ù†ÛŒ", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu58K": { name: "Ù‡Ø³ØªÛŒ Ø¯Ù„Ø´Ø§Ø¯", advisor: "Ù†Ú¯ÛŒÙ† Ù…Ù‡Ø§Ø¬Ø±" },
  "Edu59L": { name: "Ø´ÛŒØ¯Ø§ Ù†Ø§Ù†ÙˆØ§Ø²Ø§Ø¯Ù‡", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu60M": { name: "Ú©ÙˆØ«Ø± Ø®Ø³Ø±ÙˆÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu61N": { name: "Ø§Ø³Ø±Ø§ Ø·Ø§Ù„Ø¹ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu62P": { name: "Ú©Ù…Ù†Ø¯ Ú©Ø§ÙˆÙ‡", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu63Q": { name: "Ø´ÛŒÙ†Ø§ Ø¬Ø¹ÙØ±ÛŒ", advisor: "Ø­Ù†Ø§Ù†Ù‡ Ø­Ø³Ù† Ø²Ø§Ø¯Ù‡" },
  "Edu64R": { name: "Ø³Ø§Ø¬Ø¯Ù‡ Ù†Ø¹Ù…ØªÛŒ", advisor: "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡" },
  "Edu65S": { name: "Ù‡ÙˆÙ…Ù† Ù…Ø¬ÛŒØ¯ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu66T": { name: "Ø·Ù‡ Ø¨Ø²Ø§Ø±", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu67U": { name: "Ø±Ú©Ø³Ø§Ù†Ø§ Ú©Ø´Ø§ÙˆØ±Ø²", advisor: "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ" },
  "Edu68V": { name: "Ø­Ù„ÛŒØ§ Ù…Ù„Ú©", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu69W": { name: "ÙØ§Ø·Ù…Ù‡ Ø³Ø§Ø±Ø§Ù†ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "Edu70X": { name: "Ú©ÙˆØ«Ø± ØµØ¯Ø§Ù‚Øª", advisor: "Ø²Ù‡Ø±Ø§ Ù†ÙØ³" },
  "Edu71Y": { name: "Ù…Ø­Ø¯Ø«Ù‡ Ø±Ø³ØªÙ…ÛŒ", advisor: "Ù…Ø¹ØµÙˆÙ…Ù‡ Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡" },
  "Edu72Z": { name: "ÙØ§Ø·Ù…Ù‡ Ú†Ø±Ù…ÛŒ", advisor: "Ù…Ø±ÛŒÙ… Ø¬ÙˆÚ©Ø§Ø±" },
  "Edu73A": { name: "ÛŒÚ¯Ø§Ù†Ù‡ Ù…ÛŒØ±Ø²Ø§Ø®Ø§Ù†ÛŒ", advisor: "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±" },
  "Edu74B": { name: "ÙØ§Ø·Ù…Ù‡ Ù¾ÙˆØ¯ÛŒÙ†Ù‡ ÛŒÛŒ", advisor: "Ù…Ø±ÛŒÙ… Ø¬ÙˆÚ©Ø§Ø±" },
  "Edu75C": { name: "Ø¹Ø³Ù„ Ø³ÙˆØ§Ø¹Ø¯ÛŒ", advisor: "Ù…Ø±ÛŒÙ… Ø¬ÙˆÚ©Ø§Ø±" },
  "Edu76D": { name: "ÙØ§Ø·Ù…Ù‡ Ø´Ù…Ø³", advisor: "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„" },
  "Edu77E": { name: "Ù…Ù‡Ù†Ø§Ø§Ú©Ø±Ø§Ù…ÛŒ", advisor: "Ù…Ø±ÛŒÙ… Ø¬ÙˆÚ©Ø§Ø±" },
  "Edu78F": { name: "Ù…Ø¹ØµÙˆÙ…Ù‡ Ù…Ø³Ø¹ÙˆØ¯ÛŒ", advisor: "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„" },
  "Edu79G": { name: "Ù…Ø­Ø¯Ø«Ù‡ Ø³Ø§Ù„Ù… Ù†ÛŒØ§Ø±Ù‚", advisor: "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„" },
  "Edu80H": { name: "Ù†Ø§Ø²Ù†ÛŒÙ† Ø²Ù‡Ø±Ø§Ø´Ø±ÛŒÙÛŒ Ù…Ù‚Ø¯Ù…", advisor: "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„" },
  "Edu81J": { name: "Ø²Ù‡Ø±Ø§ Ø±Ø§Ø¹ÛŒ", advisor: "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„" },
  "Edu82K": { name: "Ø´Ù‚Ø§ÛŒÙ‚ Ø³Ø±Ú¯Ø²ÛŒ", advisor: "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ" },
  "123": { name: "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ØªØ³Øª", advisor: "Ù…Ø´Ø§ÙˆØ± ØªØ³Øª" }
};

/* =========================
   ØªØ¹Ø±ÛŒÙ Ù…Ø´Ø§ÙˆØ±Ù‡Ø§ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
   ========================= */
const advisors = {
  "ØªÛŒÙ†Ø§ Ø´Ú©Ø±ÛŒ": { password: "tina123", students: [] },
  "Ø±ÛŒØ­Ø§Ù†Ù‡ Ø²Ø§Ø±Ø¹": { password: "reyhaneh456", students: [] },
  "Ø­Ø§Ø¬ÛŒ Ø²Ø§Ø¯Ù‡": { password: "haji789", students: [] },
  "Ù…Ø¨ÛŒÙ†Ø§ Ø¹Ù†Ø§ÛŒØªÛŒ": { password: "mobina321", students: [] },
  "Ù…Ø¹Ø±Ø§Ø¬ Ø­Ø¨ÛŒØ¨ÛŒ": { password: "meraj852", students: [] },
  "Ù†Ú¯Ø§Ø± Ø¯Ø§ÙˆØ±ÛŒ ÙØ±": { password: "negar963", students: [] },
  "Ø²Ù‡Ø±Ø§ Ù†ÙØ³": { password: "zahra258", students: [] },
  "Ù†Ú¯ÛŒÙ† Ù…Ù‡Ø§Ø¬Ø±": { password: "negin147", students: [] },
  "ÙØ§Ø·Ù…Ù‡ Ø²Ù‡Ø±Ø§ Ú©ÙˆØ´Ú©ÛŒ": { password: "koushki753", students: [] },
  "Ø­Ù†Ø§Ù†Ù‡ Ø­Ø³Ù† Ø²Ø§Ø¯Ù‡": { password: "hananeh654", students: [] },
  "Ù…Ø¹ØµÙˆÙ…Ù‡ Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡": { password: "masoumeh951", students: [] },
  "Ù…Ø±ÛŒÙ… Ø¬ÙˆÚ©Ø§Ø±": { password: "maryam159", students: [] },
  "Ø§ÛŒØ±Ø§Ù†Ø§ Ø®ÙˆØ´Ø­Ø§Ù„": { password: "irana357", students: [] },
  "Ù…Ø´Ø§ÙˆØ± ØªØ³Øª": { password: "testtest", students: [] }
};

// Ù¾Ø±Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù‡Ø± Ù…Ø´Ø§ÙˆØ±
for (const pw in studentPasswords) {
  const s = studentPasswords[pw];
  if (advisors[s.advisor]) {
    advisors[s.advisor].students.push(s.name);
  }
}


// Check for duplicate name before login
async function checkDuplicateName(name, examName) {
  const { data, error } = await supabase
    .from('exam_results')
    .select('name')
    .eq('name', name)
    .eq('exam', examName)
    .limit(1);
  if (error) console.error(error);
  return data && data.length > 0;
}

document.getElementById("student-enter").onclick = async () => {
  const password = document.getElementById("student-name").value.trim();
  paye = document.getElementById("paye").value.trim();
  reshte = document.getElementById("reshte").value.trim();

  if (!password) return alert("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  if (!studentPasswords[password]) return alert("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
  if (!paye) return alert("Ù¾Ø§ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  if (!reshte) return alert("Ø±Ø´ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");

  // studentName and advisorName are mapped from the object
  const studentObj = studentPasswords[password];
  studentName = studentObj.name;
  advisorName = studentObj.advisor;
  // For login, just proceed (duplicate check per exam is in startExam)
  alert(studentName + " Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ğŸ‘‹");
  showStudentDashboard();
};
// Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
function showStudentDashboard() {
  // Hide login and exam/result sections
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.add("hidden");
  document.getElementById("exam-list").classList.add("hidden");
  // student-results section might not exist yet, create if needed
  let resultsSection = document.getElementById("student-results");
  if (resultsSection) resultsSection.classList.add("hidden");

  // Create dashboard container
  let dashboard = document.getElementById("student-dashboard");
  if (!dashboard) {
    dashboard = document.createElement("div");
    dashboard.id = "student-dashboard";
    dashboard.className = "container";
    document.body.prepend(dashboard);
  }
  dashboard.innerHTML = `
    <h2>ğŸ“Œ Ù¾Ù†Ù„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
    <button id="show-exams-btn">ğŸ“ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</button>
    <button id="show-results-btn">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ù…Ù†</button>
  `;

  document.getElementById("show-exams-btn").onclick = () => {
    dashboard.classList.add("hidden");
    const cont = document.getElementById("exam-container");
    cont.innerHTML = "";
    const now = new Date();

    exams.forEach((exam) => {
      const startDate = examTimes[exam].start;
      const endDate = examTimes[exam].end;
      if (now >= startDate && now <= endDate) {
        const div = document.createElement("div");
        div.className = "exam-card";
        div.innerHTML = `<h3>${exam}</h3><button onclick="startExam('${exam}')">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>`;
        cont.appendChild(div);
      }
    });
    document.getElementById("exam-list").classList.remove("hidden");
  };
  document.getElementById("show-results-btn").onclick = () => {
    dashboard.classList.add("hidden");
    // Create student-results section if it doesn't exist
    let resDiv = document.getElementById("student-results");
    if (!resDiv) {
      resDiv = document.createElement("div");
      resDiv.id = "student-results";
      resDiv.className = "container hidden";
      // Add to DOM after dashboard
      dashboard.parentNode.insertBefore(resDiv, dashboard.nextSibling);
    }
    resDiv.classList.remove("hidden");
    loadStudentResults();
  };
}
/* =========================
   Ø§ØµÙ„Ø§Ø­ Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²: Ú©Ù…ØªØ±ÛŒÙ† ØªØ±Ø§Ø² Ù‡Ø± Ø¢Ø²Ù…ÙˆÙ†
   ========================= */
async function loadStudentResults() {
  let resDiv = document.getElementById("student-results");
  if (!resDiv) return;
  resDiv.innerHTML = `
    <h2>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ù…Ù†</h2>
    <div id="my-results-table-wrap"></div>
    <br>
    <button onclick="resetStudentPanel()">ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</button>
  `;
  const tableWrap = resDiv.querySelector("#my-results-table-wrap");
  tableWrap.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";

  (async () => {
    try {
      const { data, error } = await supabase
        .from('exam_results')
        .select('exam, score, created_at, tScore, data')
        .eq('name', studentName);
      if (error) throw error;

      const attemptsByExam = {};
      if (data) {
        data.forEach(r => {
          if (!attemptsByExam[r.exam]) attemptsByExam[r.exam] = [];
          attemptsByExam[r.exam].push(r);
        });
        // Sort each exam's attempts by created_at
        for (const ex in attemptsByExam) {
          attemptsByExam[ex].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        }
      }

      const now = new Date();
      let totalPoints = 0;
      let html = `<table class="result-table"><thead>
        <tr><th>Ø¢Ø²Ù…ÙˆÙ†</th><th>Ø¯Ø±ØµØ¯</th><th>ØªØ±Ø§Ø²</th><th>ØªØ§Ø±ÛŒØ®</th></tr>
      </thead><tbody>`;

      exams.forEach(ex => {
        const atts = attemptsByExam[ex] || [];
        if (atts.length === 0) {
          html += `<tr><td>${ex}</td><td colspan="3">Ø´Ø±Ú©Øª Ù†Ú©Ø±Ø¯Ù‡</td></tr>`;
        } else {
          // Find min tScore for this exam (exclude null/undefined)
          const tScores = atts.map(a => a.tScore).filter(x => x !== null && x !== undefined && !isNaN(Number(x)));
          const minTScore = tScores.length > 0 ? Math.min(...tScores) : null;
          atts.forEach((r, idx) => {
            let dateStr = "-";
            if (r.created_at) {
              const d = new Date(r.created_at);
              const iranTime = new Date(d.getTime() + 3.5*60*60*1000);
              const y = iranTime.getFullYear();
              const m = String(iranTime.getMonth()+1).padStart(2,'0');
              const day = String(iranTime.getDate()).padStart(2,'0');
              const hour = String(iranTime.getHours()).padStart(2,'0');
              const min = String(iranTime.getMinutes()).padStart(2,'0');
              dateStr = `${y}/${m}/${day} ${hour}:${min}`;
            }
            let tScoreStr = "-";
            if (minTScore !== null) {
              tScoreStr = minTScore.toFixed(2);
              // Only add once per exam to totalPoints
              if (idx === 0) totalPoints += minTScore;
            }
            let mark = "";
            if (r.data && r.data.includes("**********")) mark = " **********";
            else if (idx > 0) mark = " **********";
            html += `<tr><td>${ex}${mark}</td><td>${r.score != null ? Number(r.score).toFixed(2)+'%' : '-'}</td><td>${tScoreStr}</td><td>${dateStr}</td></tr>`;
          });
        }
      });
      html += `<tr><td style="font-weight:bold;">Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²</td><td colspan="3" style="font-weight:bold;">${totalPoints.toFixed(2)}</td></tr>`;
      html += "</tbody></table>";
      tableWrap.innerHTML = html;
    } catch(e) {
      tableWrap.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬.</p>";
      console.error(e);
    }
  })();
}

// Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù¾Ù†Ù„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ù…Ø² Ù…Ø¬Ø¯Ø¯)
function resetStudentPanel() {
  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.add("hidden");
  const resDiv = document.getElementById("student-results");
  if(resDiv) resDiv.classList.add("hidden");

  const dashboard = document.getElementById("student-dashboard");
  if(dashboard) dashboard.remove();

  showStudentDashboard();
}

// ÙˆØ±ÙˆØ¯ Ù¾Ù†Ù„ Ù…Ø¹Ø±Ø§Ø¬ (Ø§Ø¯Ù…ÛŒÙ†)
document.getElementById("admin-enter").onclick = () => {
  if (document.getElementById("admin-pass").value === teacherPassword) {
    showTeacherPanel({ role: "admin" });
  } else {
    alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
  }
};

// ÙˆØ±ÙˆØ¯ Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ± ÙÙ‚Ø· Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ù…)
document.getElementById("advisor-enter").onclick = () => {
  const pass = document.getElementById("advisor-pass").value;
  let foundAdvisor = null;
  for (const name in advisors) {
    if (advisors[name].password === pass) {
      foundAdvisor = name;
      break;
    }
  }
  if (!foundAdvisor) {
    alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
    return;
  }
  showTeacherPanel({ role: "advisor", advisor: foundAdvisor });
};

// Modal prompt for re-exam reason (overlay modal)
async function promptReExamReason(examName) {
  return new Promise((resolve) => {
    const overlay = document.createElement("div");
    overlay.id = "reexam-overlay";
    overlay.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:#0008;display:flex;align-items:center;justify-content:center;z-index:9999;";

    const modal = document.createElement("div");
    modal.className = "container";
    modal.style = "max-width:400px;text-align:center;";
    modal.innerHTML = `
      <h3>Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
      <p>Ø¯Ù„ÛŒÙ„ Ø´Ø±Ú©Øª Ù…Ø¬Ø¯Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
      <select id="reexam-reason" style="width:80%;padding:6px;border-radius:6px;margin:8px 0;">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
        <option value="net_issue">Ù…Ø´Ú©Ù„ Ù†Øª Ùˆ Ø³Ø§ÛŒØª</option>
        <option value="other">Ø³Ø§ÛŒØ±</option>
      </select>
      <br>
      <button id="reexam-ok" style="margin:5px;">ØªØ£ÛŒÛŒØ¯</button>
      <button id="reexam-cancel" style="margin:5px;">Ù„ØºÙˆ</button>
    `;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    document.getElementById("reexam-ok").onclick = () => {
      const reason = document.getElementById("reexam-reason").value;
      overlay.remove();
      resolve(reason);
    };
    document.getElementById("reexam-cancel").onclick = () => {
      overlay.remove();
      resolve(null);
    };
  });
}

// ========== Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ÙØ¹Ø§Ù„ ==========
// Global object for tracking active students per exam
window.activeStudents = window.activeStudents || {};

// Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† (Ø¨Ø§ Ù…Ù†Ø·Ù‚ ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†)
window.startExam = async function(examName) {
  selectedExam = examName;
  const serverTime = new Date();
  let startDate = examTimes[examName].start;
  let endDate = examTimes[examName].end;

  // Warn if before start
  if (serverTime < startDate) {
    alert(`Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø§Ø² ${startDate.toLocaleString()} ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`);
    return;
  }

  // Ù…Ø¯ÛŒØ±ÛŒØª activeStudents: Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¢Ø±Ø§ÛŒÙ‡
  if (!window.activeStudents[examName]) window.activeStudents[examName] = [];
  // Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù‚Ø¨Ù„Ø§Ù‹ ÙØ¹Ø§Ù„ Ø§Ø³ØªØŸ
  let isActive = window.activeStudents[examName].includes(studentName);

  // ÙÙ‚Ø· Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª Ùˆ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡ØŒ Ø§Ø¬Ø§Ø²Ù‡ ÙˆØ±ÙˆØ¯ Ù†Ø¯Ù‡
  if (!isActive && serverTime > endDate) {
    alert(`Ù…Ù‡Ù„Øª Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª. Ø¯ÛŒÚ¯Ø± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.`);
    // Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ú¯Ø±Ø¯
    resetStudentPanel();
    return;
  }

  // Warn if remaining time less than duration
  let defaultDuration = 300;
  let examDuration = defaultDuration;
  if ((endDate - serverTime)/1000 < examDuration) {
    alert(`Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ú©Ù…ØªØ± Ø§Ø² Ù…Ø¯Øª Ø¢Ø²Ù…ÙˆÙ† Ø§Ø³Øª. Ø³Ø§Ø¹Øª ${endDate.toLocaleTimeString()} Ø¢Ø®Ø±ÛŒÙ† Ù…Ù‡Ù„Øª Ø«Ø¨Øª Ù†ØªØ§ÛŒØ¬ Ø§Ø³Øª.`);
  }

  // Check for previous attempts
  const { data: existing } = await supabase
      .from('exam_results')
      .select('id, score')
      .eq('name', studentName)
      .eq('exam', examName)
      .order('created_at', { ascending: true });

  let isReExam = false;
  if (existing && existing.length > 0 && existing.some(e => e.score != null)) {
    // At least one finished attempt exists
    const reason = await promptReExamReason(examName);
    if (!reason) return;
    if (reason !== "net_issue") {
      alert("Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø´Ø±Ú©Øª Ù…Ø¬Ø¯Ø¯ Ù†ÛŒØ³ØªÛŒØ¯.");
      resetStudentPanel();
      return;
    }
    isReExam = true;
    await supabase.from('exam_results').insert([{
      name: studentName,
      exam: examName,
      data: advisorName + " | " + paye + " | " + reshte + " **********",
      created_at: new Date().toISOString()
    }]);
  } else if (!existing || existing.length === 0) {
    await supabase.from('exam_results').insert([{
      name: studentName,
      exam: examName,
      data: advisorName + " | " + paye + " | " + reshte,
      created_at: new Date().toISOString()
    }]);
  }

  // Ø«Ø¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙØ¹Ø§Ù„ (Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯)
  if (!isActive) window.activeStudents[examName].push(studentName);

  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("exam-section").classList.remove("hidden");
  document.getElementById("exam-title").innerText = "Ø¢Ø²Ù…ÙˆÙ† " + examName;

  const zipLinks = {
    "shimi_14dey": "https://raw.githubusercontent.com/test111account/exam/main/shimi_14dey.zip"
  };
  const zipUrl = zipLinks[examName];
  if (!zipUrl) { alert("Ù„ÛŒÙ†Ú© Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯!"); return; }

  fetchAndLoadExamZip(zipUrl, examName);
};

// Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ JSZip (Ø¨Ø§ fetch Ùˆ CORS)
async function fetchAndLoadExamZip(zipUrl, examName) {
  try {
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
    document.getElementById("loading-overlay").style.display = "flex";
    // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¨Ø§ Ù¾ÛŒØ´Ø±ÙØª
    const resp = await fetch(zipUrl);
    if (!resp.ok) throw new Error("Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.");

    const contentLength = resp.headers.get("Content-Length");
    const total = contentLength ? parseInt(contentLength) : 0;
    let received = 0;

    const reader = resp.body.getReader();
    const chunks = [];

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (total > 0) {
            const percent = Math.floor((received / total) * 100);
            document.getElementById("loading-text").innerText = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯... ${percent}%`;
            document.getElementById("loading-bar").style.width = percent + "%";
        }
    }

    const zipBlob = new Blob(chunks);
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø§ JSZip
    const jszip = window.JSZip;
    const zipData = await zipBlob.arrayBuffer();
    const zip = await jszip.loadAsync(zipData);

    // Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ†
    let duration = 300;
    if (zip.file("time.txt")) {
      const timeText = await zip.file("time.txt").async("string");
      duration = parseInt(timeText.trim()) || 300;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³ÙˆØ§Ù„Ø§Øª: Ù‡Ø± Ø³ÙˆØ§Ù„ ÛŒÚ© Ø¹Ú©Ø³ Ø¨Ù‡ ØµÙˆØ±Øª 1-1.jpg ÛŒØ§ 1-1.png ... 50-4.jpg/pngØŒ Ú¯Ø²ÛŒÙ†Ù‡ ØµØ­ÛŒØ­ Ø§ÙˆÙ„ÛŒÙ† Ø¹Ú©Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
    const imgList = [];
    for (let i = 1; i <= 50; i++) {
      let found = false;
      for (let j = 1; j <= 4; j++) {
        const exts = ["jpg", "png", "PNG", "JPG"];
        for (const ext of exts) {
          const fname = `${i}-${j}.${ext}`;
          const fileObj = zip.file(fname);
          if (fileObj) {
            const blob = await fileObj.async("blob");
            const url = URL.createObjectURL(blob);
            imgList.push({ id: i, src: url, correct: j });
            found = true;
            break;
          }
        }
        if (found) break;
      }
      if (!found) break;
    }
    if (imgList.length === 0) {
      alert("Ù‡ÛŒÚ† ØªØµÙˆÛŒØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø²ÛŒÙ¾ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
      document.getElementById("loading-overlay").style.display = "none";
      return;
    }
    // Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ PDF
    let answerkeyPdfUrl = "#";
    if (zip.file("answerkey.pdf")) {
      const pdfBlob = await zip.file("answerkey.pdf").async("blob");
      answerkeyPdfUrl = URL.createObjectURL(pdfBlob);
    }
    document.getElementById("loading-overlay").style.display = "none";
    showExam(imgList, duration, examName, answerkeyPdfUrl);
  } catch (e) {
    document.getElementById("loading-overlay").style.display = "none";
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¢Ø²Ù…ÙˆÙ†");
    console.error(e);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†
function showExam(questions, duration, folder, answerkeyPdfUrl) {
  selectedExam = { folder, questions, duration_sec: duration, answerkeyPdfUrl };
  answers = new Array(questions.length).fill(null);
  currentQuestion = 0;
  renderQuestion();
  renderQList();
  // End time logic for warning and auto-finish
  let startDate = examTimes[folder].start;
  let endDate = examTimes[folder].end;
  const now = new Date();
  if ((endDate - now)/1000 < duration) {
    alert(`Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ú©Ù…ØªØ± Ø§Ø² Ù…Ø¯Øª Ø¢Ø²Ù…ÙˆÙ† Ø§Ø³Øª. Ø³Ø§Ø¹Øª ${endDate.toLocaleTimeString()} Ø¢Ø®Ø±ÛŒÙ† Ù…Ù‡Ù„Øª Ø«Ø¨Øª Ù†ØªØ§ÛŒØ¬ Ø§Ø³Øª.`);
  }
  startTimer(duration, endDate);
  document.getElementById("prev-btn").style.display = "";
  document.getElementById("next-btn").style.display = "";
  document.getElementById("finish-btn").style.display = "";
  document.getElementById("question-list").style.display = "flex";
}

// Ù†Ù…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„
function renderQuestion() {
  const q = selectedExam.questions[currentQuestion];
  const box = document.getElementById("question-box");
  box.innerHTML = `<img src="${q.src}" alt="question">`;
  for (let i = 1; i <= 4; i++) {
    const div = document.createElement("div");
    div.className = "option";
    if (answers[currentQuestion] === i) div.style.background = "#d0c4f7";
    div.innerText = `Ú¯Ø²ÛŒÙ†Ù‡ ${i}`;
    div.onclick = () => {
      if (answers[currentQuestion] === i) {
        answers[currentQuestion] = null; // Deselect if the same option is clicked
      } else {
        answers[currentQuestion] = i; // Select new option
      }
      renderQuestion();
      renderQList();
    };
    box.appendChild(div);
  }
  document.querySelectorAll(".qnum").forEach((e, i) => {
      e.classList.remove("active");
      if (i === currentQuestion) e.classList.add("active");
  });
}

// Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„Ø§Øª
document.getElementById("next-btn").onclick = () => { if (currentQuestion < selectedExam.questions.length - 1) { currentQuestion++; renderQuestion(); } };
document.getElementById("prev-btn").onclick = () => { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } };

// Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ú©Ù…Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¯Ø± exam-list Ùˆ result-section (Ù†Ù‡ Ø¯Ø± exam-section)
function ensureMainButtons() {
  // exam-list
  let examList = document.getElementById("exam-list");
  if (examList && !examList.querySelector(".back-to-dashboard-btn")) {
    const btn = document.createElement("button");
    btn.className = "back-to-dashboard-btn";
    btn.innerText = "ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ";
    btn.onclick = resetStudentPanel;
    examList.appendChild(btn);
  }
  // result-section
  let resultSection = document.getElementById("result-section");
  if (resultSection && !resultSection.querySelector(".back-to-dashboard-btn")) {
    const btn = document.createElement("button");
    btn.className = "back-to-dashboard-btn";
    btn.innerText = "ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ";
    btn.onclick = resetStudentPanel;
    resultSection.appendChild(btn);
  }
}
// Add main buttons on load
ensureMainButtons();

// Ù„ÛŒØ³Øª Ø³Ø¤Ø§Ù„Ø§Øª Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡
function renderQList() {
  const list = document.getElementById("question-list"); list.innerHTML = "";
  selectedExam.questions.forEach((_, i) => {
    const b = document.createElement("div");
    b.className = "qnum"; b.innerText = i + 1;
    if (answers[i] != null) {
        b.classList.add("answered");
    } else {
        b.classList.add("unanswered");
    }

    if (i === currentQuestion) {
        b.classList.add("active");
    }

    b.onclick = () => { currentQuestion = i; renderQuestion(); };
    list.appendChild(b);
  });
}

// ØªØ§ÛŒÙ…Ø± Ø¨Ø§ Ú†Ú© Ú©Ø±Ø¯Ù† Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ†
function startTimer(sec, endDate = null) {
  remainingTime = sec;
  const timer = document.getElementById("timer");
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    remainingTime--;
    const m = Math.floor(remainingTime / 60), s = remainingTime % 60;
    timer.innerText = `â° ${m}:${s.toString().padStart(2, '0')}`;
    // Check if time is up
    if (remainingTime <= 0) {
      clearInterval(timerInterval);
      finishExam();
      return;
    }
    // Check if exam end time passed
    // Ø§Ù…Ø§ Ø§Ú¯Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ (ÙÙ‚Ø· ØªØ§ÛŒÙ…Ø± Ú©Ø§Ø± Ú©Ù†Ø¯)
    if (endDate && new Date() >= endDate) {
      // Ø§Ú¯Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ (Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†)
      if (
        window.activeStudents &&
        selectedExam &&
        selectedExam.folder &&
        window.activeStudents[selectedExam.folder] &&
        window.activeStudents[selectedExam.folder].includes(studentName)
      ) {
        // ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø± ÛŒÚ©Ø¨Ø§Ø±
        if (!timer.dataset.warned) {
          alert("Ù…Ù‡Ù„Øª Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ù…Ø§ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø³Ø§Ù†ÛŒØ¯.");
          timer.dataset.warned = "1";
        }
        // ØªØ§ÛŒÙ…Ø± Ø§Ø¯Ø§Ù…Ù‡ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        return;
      } else {
        clearInterval(timerInterval);
        finishExam();
        return;
      }
    }
  }, 1000);
}

document.getElementById("finish-btn").onclick = finishExam;

// Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ (Supabase Only, Ø±ØªØ¨Ù‡ Ùˆ ØªØ±Ø§Ø² ØµØ­ÛŒØ­ Ø¨Ø§ Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ)
let isSavingResult = false;

async function finishExam() {
  if (isSavingResult) return; // prevent multiple clicks
  isSavingResult = true;
  clearInterval(timerInterval);

  let correct = 0, wrong = 0, empty = 0;
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    if (ans == null) empty++;
    else if (ans === q.correct) correct++;
    else wrong++;
  });

  // Ù†Ù…Ø±Ù‡ Ø¨Ø§ Ù…Ù†ÙÛŒ
  const rawScore = correct - wrong / 3;
  const totalQuestions = selectedExam.questions.length;
  const percentScore = (rawScore / totalQuestions) * 100;

  // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  let allScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, score, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allScores = data.map(r => ({ name: r.name, score: r.score, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ùˆ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø± Ø¯Ø±ØµØ¯Ù‡Ø§
  const percentList = allScores.map(r => Number(r.score)).filter(x => !isNaN(x));
  percentList.push(percentScore); // Ø¯Ø±ØµØ¯ ÙØ¹Ù„ÛŒ Ø±Ø§ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† (ØªØ§ Ø¯Ø± Ø¬Ù…Ø¹ Ù„Ø­Ø§Ø¸ Ø´ÙˆØ¯)
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
  const mean = percentList.length > 0 ? percentList.reduce((a, b) => a + b, 0) / percentList.length : 50;
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø±
  let stdDev = 10;
  if (percentList.length > 1) {
    const variance = percentList.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / percentList.length;
    stdDev = Math.sqrt(variance);
    // Ø§Ú¯Ø± stdDev Ø®ÛŒÙ„ÛŒ Ú©Ù… Ø´Ø¯ØŒ Ø­Ø¯Ø§Ù‚Ù„ 5 Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ØªØ§ ØªØ±Ø§Ø² Ù…Ø¹Ù†Ø§Ø¯Ø§Ø± Ø¨Ù…Ø§Ù†Ø¯
    if (stdDev < 5) stdDev = 5;
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  const tScore = 5000 + 1000 * (percentScore - mean) / stdDev;

  // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ÙØ¹Ù„ÛŒ Ø¯Ø± Supabase (Ø¨Ø§ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±ÛŒ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ú©ÙˆØ±Ø¯ Ù†Ø§Ù‚Øµ)
  try {
      // Check for existing record with same student, advisor, and paye
      // If data includes **********, mark as re-exam
      let dataStr = advisorName + " | " + paye + " | " + reshte;
      // If this attempt is a re-exam (data already includes ********** or previous record with **********), add stars
      // Actually, always mark as re-exam if data has stars, or if this is NOT the first attempt (see logic at startExam)
      const { data: existing, error: fetchError } = await supabase
          .from('exam_results')
          .select('id, score, data')
          .eq('name', studentName)
          .eq('exam', selectedExam.folder)
          .eq('data', dataStr)
          .limit(1);

      if (fetchError) throw fetchError;

      // If the current attempt is a re-exam (data includes stars), always write stars in data
      // If existing record (with this data) has **********, keep it for update; else, add if this is a re-exam
      let isReExam = false;
      // Determine if this is a re-exam by checking if data string for this attempt includes stars (from startExam logic)
      if (dataStr.includes("**********")) isReExam = true;
      // Or, if there is any previous record for this student/exam with data including **********
      // (but for update, keep data as is)
      // For insert, if not first attempt, add stars
      // For update, keep data as is
      if (existing && existing.length > 0 && (existing[0].score === null || existing[0].score === undefined)) {
          // Update the existing record
          await supabase
            .from('exam_results')
            .update({
              score: percentScore,
              tScore: tScore,
              created_at: new Date().toISOString()
            })
            .eq('id', existing[0].id);
      } else if (!existing || existing.length === 0) {
          // Insert new record if none exists
          // If this is a re-exam, always add stars
          let insertDataStr = dataStr;
          // If this is a re-exam, ensure stars
          if (dataStr.includes("**********")) {
            insertDataStr = dataStr;
          } else {
            // Check if there is any previous record for this student/exam with data not matching this advisor|paye|reshte, but with stars
            // Instead, better: if any previous attempt for this exam for this student (with any data) with score != null, and this data is not the first, mark as re-exam
            const { data: allAtts } = await supabase
              .from('exam_results')
              .select('id, data')
              .eq('name', studentName)
              .eq('exam', selectedExam.folder);
            if (allAtts && allAtts.length > 0 && allAtts.some(r => r.data && r.data.includes("**********"))) {
              insertDataStr = dataStr + " **********";
            }
          }
          await supabase
            .from('exam_results')
            .insert([{
              name: studentName,
              exam: selectedExam.folder,
              score: percentScore,
              tScore: tScore,
              data: insertDataStr,
              created_at: new Date().toISOString()
            }]);
      }
  } catch (error) {
      console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡:", error);
  } finally {
      isSavingResult = false;
  }

  // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬Ø¯Ø¯ Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
  let allTScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allTScores = data.map(r => ({ name: r.name, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ:
  // 1. Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø±Ø§ Ù†Ø²ÙˆÙ„ÛŒ Ù…Ø±ØªØ¨ Ú©Ù†
  // 2. Ø±ØªØ¨Ù‡ Ù‡Ø± ØªØ±Ø§Ø² Ø±Ø§ Ø¯Ø± ÛŒÚ© Map Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
  // 3. Ø±ØªØ¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² = Ù…Ù‚Ø¯Ø§Ø± Map Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ø² Ø®ÙˆØ¯Ø´
  const tScoresSorted = allTScores
    .map(r => Number(r.tScore))
    .filter(x => !isNaN(x));
  tScoresSorted.sort((a, b) => b - a);
  const tScoreToRank = new Map();
  let rank = 1;
  for (let i = 0; i < tScoresSorted.length; i++) {
    const ts = tScoresSorted[i];
    if (!tScoreToRank.has(ts)) {
      tScoreToRank.set(ts, rank);
      rank++;
    }
  }
  const myRank = tScoreToRank.has(tScore) ? tScoreToRank.get(tScore) : tScoresSorted.length;
  const totalParticipants = tScoresSorted.length;

  // Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ø² Ù„ÛŒØ³Øª ÙØ¹Ø§Ù„â€ŒÙ‡Ø§ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
  if (
    window.activeStudents &&
    selectedExam &&
    selectedExam.folder &&
    window.activeStudents[selectedExam.folder]
  ) {
    const idx = window.activeStudents[selectedExam.folder].indexOf(studentName);
    if (idx !== -1) window.activeStudents[selectedExam.folder].splice(idx, 1);
  }

  // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.remove("hidden");

  document.getElementById("score-summary").innerHTML = `
    <p>ğŸ¯ Ø¯Ø±ØµØ¯ Ù†Ù…Ø±Ù‡: <b>${percentScore.toFixed(2)}%</b></p>
    <p>âœ… Ø¯Ø±Ø³Øª: ${correct} | âŒ ØºÙ„Ø·: ${wrong} | âº Ù†Ø²Ø¯Ù‡: ${empty}</p>
  `;

  const tbody = document.getElementById("result-body");
  tbody.innerHTML = "";
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    let statusClass = "", statusText = "";
    if (ans == null) { statusClass = "empty"; statusText = "Ù†Ø²Ø¯Ù‡"; }
    else if (ans === q.correct) { statusClass = "correct"; statusText = "Ø¯Ø±Ø³Øª"; }
    else { statusClass = "wrong"; statusText = "ØºÙ„Ø·"; }

    const row = `<tr>
      <td>${i + 1}</td>
      <td>${ans ? ans : "-"}</td>
      <td>${q.correct}</td>
      <td class="${statusClass}">${statusText}</td>
    </tr>`;
    tbody.innerHTML += row;
  });

  // Ø¯Ú©Ù…Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (Ø§Ú¯Ø± Ù†ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†)
  ensureMainButtons();

  // ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± PDF Ø§Ø² Ø¨Ø®Ø´ Ù†ØªÛŒØ¬Ù‡ Ù¾Ø³ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ú†Ù†Ø¯ ØµÙØ­Ù‡)
  setTimeout(async () => {
      try {
          const resultSection = document.getElementById("result-section");
          const canvas = await html2canvas(resultSection, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/png");

          const pdf = new jspdf.jsPDF({
              orientation: "portrait",
              unit: "pt",
              format: "a4"
          });

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = pageWidth - 40;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          let remainingHeight = imgHeight;
          let positionY = 20;

          pdf.addImage(imgData, "PNG", 20, positionY, imgWidth, imgHeight);

          while (remainingHeight > pageHeight - 40) {
              pdf.addPage();
              remainingHeight -= (pageHeight - 40);
              positionY = 20 - remainingHeight;
              pdf.addImage(imgData, "PNG", 20, positionY, imgWidth, imgHeight);
          }

          pdf.save(`Ú¯Ø²Ø§Ø±Ø´_Ø¢Ø²Ù…ÙˆÙ†_${studentName}.pdf`);
      } catch (e) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF:", e);
      }
  }, 1000);
}

// Ø­Ø°Ù Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± localStorage (Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…/Ù…Ø´Ø§ÙˆØ± (Supabase)
function showTeacherPanel(options = {}) {
  // options: {role: "admin"|"advisor", advisor: "..." }
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("teacher-panel").classList.remove("hidden");
  // Set panel title
  const panelTitle = document.getElementById("teacher-panel-title");
  if (options.role === "advisor" && options.advisor) {
    panelTitle.innerText = "ğŸ“Š Ù¾Ù†Ù„ " + options.advisor;
  } else {
    panelTitle.innerText = "ğŸ“Š Ù¾Ù†Ù„ Ù…Ø¹Ø±Ø§Ø¬";
  }
  // Default: show exam section, hide others
  document.getElementById("teacher-panel-exam-section").classList.remove("hidden");
  document.getElementById("teacher-panel-student-section").classList.add("hidden");
  document.getElementById("teacher-panel-advisor-scores-section").classList.add("hidden");
  document.getElementById("teacher-panel-student-scores-section").classList.add("hidden");
  document.getElementById("teacher-tab-exam").classList.add("exam-btn-selected");
  document.getElementById("teacher-tab-student").classList.remove("exam-btn-selected");
  document.getElementById("teacher-tab-advisor-scores").classList.remove("exam-btn-selected");
  document.getElementById("teacher-tab-student-scores").classList.remove("exam-btn-selected");

  // Exam tab
  const list = document.getElementById("teacher-exam-list");
  list.innerHTML = "";
  const resultsTable = document.getElementById("results-table");
  resultsTable.classList.add("hidden"); // hide initially
  // Only show "Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ø²Ù…ÙˆÙ†" tab for admin, not advisor
  if (!(options.role === "advisor" && options.advisor)) {
    exams.forEach(ex => {
      const btn = document.createElement("button");
      btn.style.margin = "5px";
      btn.innerText = ex;
      btn.onclick = () => {
        // Remove highlight from all buttons
        document.querySelectorAll("#teacher-exam-list button").forEach(b => b.classList.remove("exam-btn-selected"));
        // Highlight the selected button
        btn.classList.add("exam-btn-selected");
        // Show the results table
        resultsTable.classList.remove("hidden");
        loadTeacherResults(ex, null);
      };
      list.appendChild(btn);
    });
  }

  // Student tab setup
  if (options.role === "advisor" && options.advisor) {
    setupTeacherStudentTab(advisors[options.advisor].students);
  } else {
    setupTeacherStudentTab();
  }

  // Tab switching logic
  // Hide "Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ø²Ù…ÙˆÙ†" tab for advisor
  if (options.role === "advisor" && options.advisor) {
    document.getElementById("teacher-tab-exam").style.display = "none";
    document.getElementById("teacher-panel-exam-section").classList.add("hidden");
  } else {
    document.getElementById("teacher-tab-exam").style.display = "";
  }
  document.getElementById("teacher-tab-exam").onclick = function() {
    document.getElementById("teacher-panel-exam-section").classList.remove("hidden");
    document.getElementById("teacher-panel-student-section").classList.add("hidden");
    document.getElementById("teacher-panel-advisor-scores-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-scores-section").classList.add("hidden");
    this.classList.add("exam-btn-selected");
    document.getElementById("teacher-tab-student").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-advisor-scores").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-student-scores").classList.remove("exam-btn-selected");
  };
  document.getElementById("teacher-tab-student").onclick = function() {
    document.getElementById("teacher-panel-exam-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-section").classList.remove("hidden");
    document.getElementById("teacher-panel-advisor-scores-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-scores-section").classList.add("hidden");
    this.classList.add("exam-btn-selected");
    document.getElementById("teacher-tab-exam").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-advisor-scores").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-student-scores").classList.remove("exam-btn-selected");
    // On switching, load student list if not already loaded
    if (options.role === "advisor" && options.advisor) {
      setupTeacherStudentTab(advisors[options.advisor].students);
    } else {
      setupTeacherStudentTab();
    }
  };
  document.getElementById("teacher-tab-advisor-scores").onclick = function() {
    document.getElementById("teacher-panel-exam-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-section").classList.add("hidden");
    document.getElementById("teacher-panel-advisor-scores-section").classList.remove("hidden");
    document.getElementById("teacher-panel-student-scores-section").classList.add("hidden");
    this.classList.add("exam-btn-selected");
    document.getElementById("teacher-tab-exam").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-student").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-student-scores").classList.remove("exam-btn-selected");
    showAdvisorScores(options);
  };
  document.getElementById("teacher-tab-student-scores").onclick = function() {
    document.getElementById("teacher-panel-exam-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-section").classList.add("hidden");
    document.getElementById("teacher-panel-advisor-scores-section").classList.add("hidden");
    document.getElementById("teacher-panel-student-scores-section").classList.remove("hidden");
    this.classList.add("exam-btn-selected");
    document.getElementById("teacher-tab-exam").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-student").classList.remove("exam-btn-selected");
    document.getElementById("teacher-tab-advisor-scores").classList.remove("exam-btn-selected");
    loadStudentScores(options);
  };
}

// Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡Ø§ (Ø¬Ù…Ø¹ ØªØ±Ø§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù‡Ø± Ù…Ø´Ø§ÙˆØ±)
async function showAdvisorScores(options = {}) {
  const wrap = document.getElementById("advisor-scores-table-wrap");
  wrap.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
  try {
    // Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ù†ØªØ§ÛŒØ¬
    let query = supabase
      .from('exam_results')
      .select('name, tScore, data, exam');
    let { data, error } = await query;
    if (error) throw error;
    // ÙÙ‚Ø· Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù…Ø´Ø§ÙˆØ± Ø¬Ø§Ø±ÛŒ (Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±)
    let allowedStudents = null;
    if (options.role === "advisor" && options.advisor) {
      allowedStudents = advisors[options.advisor].students;
    }
    if (allowedStudents) {
      data = data.filter(r => allowedStudents.includes(r.name));
    }
    // Ø³Ø§Ø®Øª map: advisor -> Ø¬Ù…Ø¹ ØªØ±Ø§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
    const advisorMap = {};
    // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ØŒ Ø¬Ù…Ø¹ Ú©Ù…ØªØ±ÛŒÙ† ØªØ±Ø§Ø² Ù‡Ø± Ø¢Ø²Ù…ÙˆÙ† (Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²)
    const studentExamMinTScore = {};
    // Build mapping from student name to advisor using advisors object
    const nameToAdvisor = {};
    for (const advName in advisors) {
      advisors[advName].students.forEach(s => { nameToAdvisor[s] = advName; });
    }
    (data||[]).forEach(r => {
      if (!r.name || r.tScore == null || isNaN(Number(r.tScore))) return;
      // Ù†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª advisors Ø¨Ú¯ÛŒØ±
      let adv = nameToAdvisor[r.name] || "Ù†Ø§Ù…Ø´Ø®Øµ";
      if (!studentExamMinTScore[r.name]) studentExamMinTScore[r.name] = {};
      if (!studentExamMinTScore[r.name][r.exam]) studentExamMinTScore[r.name][r.exam] = Number(r.tScore);
      else studentExamMinTScore[r.name][r.exam] = Math.min(studentExamMinTScore[r.name][r.exam], Number(r.tScore));
      // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
      if (!studentExamMinTScore[r.name]._advisor) studentExamMinTScore[r.name]._advisor = adv;
    });
    // Ø­Ø§Ù„Ø§ Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù‡Ø± Ù…Ø´Ø§ÙˆØ± Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†
    for (const student in studentExamMinTScore) {
      const sData = studentExamMinTScore[student];
      let adv = sData._advisor || "Ù†Ø§Ù…Ø´Ø®Øµ";
      let sum = 0;
      for (const ex in sData) {
        if (ex === "_advisor") continue;
        sum += Number(sData[ex]);
      }
      if (!advisorMap[adv]) advisorMap[adv] = { total: 0, students: [] };
      advisorMap[adv].total += sum;
      advisorMap[adv].students.push({ name: student, total: sum });
    }
    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù†Ø²ÙˆÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ total
    const advisorList = Object.entries(advisorMap)
      .map(([name, obj]) => ({ name, total: obj.total, count: obj.students.length }))
      .sort((a, b) => b.total - a.total);
    // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„
    let html = `<table class="result-table"><thead>
      <tr><th>Ø±ØªØ¨Ù‡</th><th>Ù…Ø´Ø§ÙˆØ±</th><th>Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²</th><th>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th></tr>
    </thead><tbody>`;
    advisorList.forEach((a, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${a.name}</td>
        <td>${a.total.toFixed(2)}</td>
        <td>${a.count}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    wrap.innerHTML = html;
  } catch (e) {
    wrap.innerHTML = "<span style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡Ø§</span>";
    console.error(e);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† (Ø¬Ù…Ø¹ ØªØ±Ø§Ø²)
async function loadStudentScores(options = {}) {
  const wrap = document.getElementById("student-scores-table-wrap");
  wrap.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
  try {
    let query = supabase
      .from('exam_results')
      .select('name, tScore, data, exam');
    let { data, error } = await query;
    if (error) throw error;
    // ÙÙ‚Ø· Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù…Ø´Ø§ÙˆØ± Ø¬Ø§Ø±ÛŒ (Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±)
    let allowedStudents = null;
    if (options.role === "advisor" && options.advisor) {
      allowedStudents = advisors[options.advisor].students;
    }
    if (allowedStudents) {
      data = data.filter(r => allowedStudents.includes(r.name));
    }
    // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ØŒ Ø¬Ù…Ø¹ Ú©Ù…ØªØ±ÛŒÙ† ØªØ±Ø§Ø² Ù‡Ø± Ø¢Ø²Ù…ÙˆÙ† (ÛŒØ¹Ù†ÛŒ Ù‡Ø± Ø¢Ø²Ù…ÙˆÙ† ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø±)
    const studentMap = {};
    (data||[]).forEach(r => {
      if (!r.name || r.tScore == null || isNaN(Number(r.tScore))) return;
      if (!studentMap[r.name]) studentMap[r.name] = { total: 0, exams: {} };
      if (!studentMap[r.name].exams[r.exam]) studentMap[r.name].exams[r.exam] = Number(r.tScore);
      else studentMap[r.name].exams[r.exam] = Math.min(studentMap[r.name].exams[r.exam], Number(r.tScore));
      // Ù†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø±Ø§ Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
      if (!studentMap[r.name]._advisor && r.data && typeof r.data === "string") {
        const parts = r.data.split("|");
        if (parts.length >= 1) studentMap[r.name]._advisor = parts[0].trim();
      }
    });
    // Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø² Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
    for (const name in studentMap) {
      const s = studentMap[name];
      s.total = 0;
      for (const ex in s.exams) {
        s.total += Number(s.exams[ex]);
      }
    }
    // Ù„ÛŒØ³Øª Ù†Ø²ÙˆÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ total
    const studentList = Object.entries(studentMap)
      .map(([name, obj]) => ({ name, total: obj.total, advisor: obj._advisor || "-" }))
      .sort((a, b) => b.total - a.total);
    // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„
    let html = `<table class="result-table"><thead>
      <tr><th>Ø±ØªØ¨Ù‡</th><th>Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th><th>Ù…Ø´Ø§ÙˆØ±</th><th>Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²</th></tr>
    </thead><tbody>`;
    studentList.forEach((s, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${s.name}</td>
        <td>${s.advisor}</td>
        <td>${s.total.toFixed(2)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    wrap.innerHTML = html;
  } catch (e) {
    wrap.innerHTML = "<span style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</span>";
    console.error(e);
  }
}

// Setup and load student list for the teacher panel
// studentList: optional array of allowed student names
async function setupTeacherStudentTab(studentList = null) {
  const studentListDiv = document.getElementById("teacher-student-list");
  if (!studentListDiv) return;
  // Always reload (to allow different advisor logins)
  studentListDiv.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
  try {
    // Use names from studentPasswords for consistency
    let studentNames = Object.values(studentPasswords)
      .map(o => o.name)
      .filter((name, idx, arr) => arr.indexOf(name) === idx);
    if (studentList) {
      // Only show allowed students
      studentNames = studentNames.filter(n => studentList.includes(n));
    }
    studentNames = studentNames.sort((a, b) => a.localeCompare(b, 'fa'));
    studentListDiv.innerHTML = "";
    studentNames.forEach(name => {
      const btn = document.createElement("button");
      btn.innerText = name;
      btn.style.margin = "2px 4px";
      btn.onclick = function() {
        // Remove highlight from all buttons
        studentListDiv.querySelectorAll("button").forEach(b=>b.classList.remove("exam-btn-selected"));
        btn.classList.add("exam-btn-selected");
        showStudentResultsTable(name);
      };
      studentListDiv.appendChild(btn);
    });
  } catch (e) {
    studentListDiv.innerHTML = "<span style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</span>";
    console.error(e);
  }
}

// Load and show results for a specific student
async function showStudentResultsTable(studentName) {
  const table = document.getElementById("student-results-table");
  const tbody = table.querySelector("tbody");
  const nameDiv = document.getElementById("teacher-student-selected-name");
  table.classList.add("hidden");
  nameDiv.innerText = studentName ? "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²: " + studentName : "";
  if (!studentName) return;
  tbody.innerHTML = "";
  table.classList.remove("hidden");
  // Fetch all attempts for this student
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('exam, score, created_at, tScore, data')
      .eq('name', studentName);
    if (error) throw error;
    // Group by exam, keep all attempts (sorted by created_at)
    const attemptsByExam = {};
    (data||[]).forEach(r => {
      if (!attemptsByExam[r.exam]) attemptsByExam[r.exam] = [];
      attemptsByExam[r.exam].push(r);
    });
    for (const ex in attemptsByExam) {
      attemptsByExam[ex].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    }
    const now = new Date();
    let totalPoints = 0;
    // Show in exam order
    exams.forEach(ex => {
      const atts = attemptsByExam[ex] || [];
      if (atts.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${ex}</td><td colspan="3">Ø´Ø±Ú©Øª Ù†Ú©Ø±Ø¯Ù‡</td>`;
        tbody.appendChild(tr);
      } else {
        atts.forEach((r, idx) => {
          let dateStr = "-";
          if (r.created_at) {
            const d = new Date(r.created_at);
            const iranTime = new Date(d.getTime() + 3.5*60*60*1000);
            const y = iranTime.getFullYear();
            const m = String(iranTime.getMonth()+1).padStart(2,'0');
            const day = String(iranTime.getDate()).padStart(2,'0');
            const hour = String(iranTime.getHours()).padStart(2,'0');
            const min = String(iranTime.getMinutes()).padStart(2,'0');
            dateStr = `${y}/${m}/${day} ${hour}:${min}`;
          }
          let startDate = examTimes[ex].start;
          let endDate = examTimes[ex].end;
          let tScoreStr = "-";
          // Only show tScore if exam ended
          if (endDate < now && r.tScore !== undefined && r.tScore !== null && !isNaN(Number(r.tScore))) {
            tScoreStr = Number(r.tScore).toFixed(2);
            // Only include tScore for finished exams in total points (Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø² ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù¾Ø§ÛŒØ§Ù†â€ŒØ´Ø§Ù† Ú¯Ø°Ø´ØªÙ‡)
            totalPoints += Number(r.tScore);
          }
          let mark = "";
          if (r.data && r.data.includes("**********")) mark = " **********";
          else if (idx > 0) mark = " **********";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${ex}${mark}</td><td>${r.score != null ? Number(r.score).toFixed(2)+'%' : '-'}</td><td>${tScoreStr}</td><td>${dateStr}</td>`;
          tbody.appendChild(tr);
        });
      }
    });
    // Add total points row (Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²)
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="font-weight:bold;">Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²</td><td colspan="3" style="font-weight:bold;">${totalPoints.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="4">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬</td></tr>`;
    console.error(e);
  }
}

// Ù„ÙˆØ¯ Ù†ØªØ§ÛŒØ¬ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø§Ø² Supabase Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø«Ø¨Øª Ùˆ Ø³ØªÙˆÙ† ØªØ±Ø§Ø²
// allowedStudents: optional array of names to filter
async function loadTeacherResults(selectedExamName = null, allowedStudents = null) {
  const tbody = document.querySelector("#teacher-panel tbody");
  tbody.innerHTML = "";
  document.getElementById("results-table").classList.remove("hidden");
  try {
    let query = supabase
      .from('exam_results')
      .select('name, exam, score, created_at, data');
    if (selectedExamName) query = query.eq('exam', selectedExamName);
    let { data, error } = await query;
    // Debug: Print all received data and error
    console.log("Supabase data received:", data, "Error:", error);
    if (error) throw error;

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ø§Øª ÙØ¹Ù„ÛŒ
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ÙÙ‚Ø· Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†Ù…Ø±Ù‡ Ø¯Ø§Ø±Ù†Ø¯ (null Ù†Ø¨Ø§Ø´Ø¯)
    // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù…Ø¬Ø§Ø² (Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ±)
    if (allowedStudents && Array.isArray(allowedStudents)) {
      data = data.filter(r => allowedStudents.includes(r.name));
    }

    const validScores = data.filter(r => r.score !== null && r.score !== undefined);
    const percentList = validScores.map(r => Number(r.score)).filter(x => !isNaN(x));
    // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ù†Ø¨ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ±)
    const mean = percentList.length > 0 ? percentList.reduce((a, b) => a + b, 0) / percentList.length : 50;
    let stdDev = 10;
    if (percentList.length > 1) {
      const variance = percentList.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / percentList.length;
      stdDev = Math.sqrt(variance);
      if (stdDev < 5) stdDev = 5;
    }

    // sort descending by score
    data.sort((a, b) => (b.score || 0) - (a.score || 0));
    data.forEach((r, index) => {
        // Debug: Print each record to inspect column names and values
        console.log("Record:", r); // Print each record to inspect column names and values

        let dateStr = "-";
        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø¨Ù‡ ÙˆÙ‚Øª Ø§ÛŒØ±Ø§Ù† (UTC+3:30)
        if (r.created_at) {
            try {
                const d = new Date(r.created_at); // UTC time
                // Convert to Iran local time by adding 3.5 hours
                const iranTime = new Date(d.getTime() + (3.5 * 60 * 60 * 1000));
                const y = iranTime.getFullYear();
                const m = String(iranTime.getMonth() + 1).padStart(2, '0');
                const day = String(iranTime.getDate()).padStart(2, '0');
                const hour = String(iranTime.getHours()).padStart(2, '0');
                const min = String(iranTime.getMinutes()).padStart(2, '0');
                dateStr = `${y}/${m}/${day} ${hour}:${min}`;
            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø§ÛŒØ±Ø§Ù†:", e);
            }
        }

        const scoreDisplay = r.score != null ? Number(r.score).toFixed(2) : "-";
        // ØªØ±Ø§Ø² Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† (Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…ÙˆÙ„)
        let tScoreDisplay = "-";
        if (r.score !== null && r.score !== undefined && !isNaN(Number(r.score))) {
          const tScoreCalc = 5000 + 1000 * ((Number(r.score) - mean) / stdDev);
          tScoreDisplay = tScoreCalc.toFixed(2);
        }

        const row = document.createElement("tr");

        // DELETE rank-based highlighting classes (no longer needed)

        const info = r.data || "";
        // Emoji-based ranking, no colors
        let rankEmoji = "";
        if (index === 0) rankEmoji = "ğŸ¥‡";
        else if (index === 1) rankEmoji = "ğŸ¥ˆ";
        else if (index === 2) rankEmoji = "ğŸ¥‰";
        else if (index < 10) rankEmoji = "â­";
        else if (index < 20) rankEmoji = "ğŸ”¹";

        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${rankEmoji} ${r.name}<br><span style="font-size:11px;color:#555">${info}</span></td>
            <td>${scoreDisplay}%</td>
            <td>${tScoreDisplay}</td>
            <td>${dateStr}</td>
        `;
        tbody.appendChild(row);
    });
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬</td></tr>`;
    console.error(e);
  }
}
// Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ (XLSX Ø¨Ø§ SheetJS)
document.getElementById("download-excel").onclick = async () => {
    const selectedExamName = document.querySelector("#teacher-exam-list button.exam-btn-selected")?.innerText;
    if (!selectedExamName) return alert("ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");

    try {
        const { data, error } = await supabase
            .from('exam_results')
            .select('name, score, created_at, data')
            .eq('exam', selectedExamName);
        if (error) throw error;
        if (!data || data.length === 0) return alert("Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");

        // ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù† Ø¨Ù‡ Ø§ÛŒØ±Ø§Ù† Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø²
        const validScores = data.filter(r => r.score !== null && r.score !== undefined);
        const percentList = validScores.map(r => Number(r.score)).filter(x => !isNaN(x));
        const mean = percentList.length > 0 ? percentList.reduce((a,b)=>a+b,0)/percentList.length : 50;
        let stdDev = 10;
        if (percentList.length > 1) {
            const variance = percentList.reduce((sum,x)=>sum+Math.pow(x-mean,2),0)/percentList.length;
            stdDev = Math.sqrt(variance);
            if (stdDev < 5) stdDev = 5;
        }

        // sort descending by score
        data.sort((a,b)=> (b.score || 0) - (a.score || 0));

        const rows = data.map(r => {
            let dateStr = "-";
            if (r.created_at) {
                const d = new Date(r.created_at);
                const iranTime = new Date(d.getTime() + (3.5*60*60*1000));
                const y = iranTime.getFullYear();
                const m = String(iranTime.getMonth()+1).padStart(2,'0');
                const day = String(iranTime.getDate()).padStart(2,'0');
                const hour = String(iranTime.getHours()).padStart(2,'0');
                const min = String(iranTime.getMinutes()).padStart(2,'0');
                dateStr = `${y}/${m}/${day} ${hour}:${min}`;
            }
            const score = r.score != null ? Number(r.score).toFixed(2) : "-";
            const tScoreCalc = (r.score != null && !isNaN(Number(r.score))) ? 5000 + 1000 * ((Number(r.score)-mean)/stdDev) : "-";
            return {
                "Ù†Ø§Ù…": r.name,
                "Ù¾Ø§ÛŒÙ‡ | Ø±Ø´ØªÙ‡ | Ù…Ø´Ø§ÙˆØ±": r.data || "",
                "Ø¯Ø±ØµØ¯": score,
                "ØªØ±Ø§Ø²": tScoreCalc !== "-" ? tScoreCalc.toFixed(2) : "-",
                "ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª": dateStr
            };
        });

        // Ø³Ø§Ø®Øª Ø§Ú©Ø³Ù„ Ø¨Ø§ SheetJS
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ SheetJS ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
        if (!window.XLSX) {
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ SheetJS Ø§Ø² CDN
            await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }
        // Ø³Ø§Ø®Øª ÙˆØ±Ú©â€ŒØ¨ÙˆÚ© Ùˆ Ø´ÛŒØª
        const ws = window.XLSX.utils.json_to_sheet(rows);
        // ØªÙ†Ø¸ÛŒÙ… Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† Ùˆ ÙÙˆÙ†Øª (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ SheetJS Pro Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ù…Ù„ Ø§Ø³Øª ÙˆÙ„ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†)
        // Ø§Ù…Ø§ Ø§Ú©Ø³Ù„ ÙØ§Ø±Ø³ÛŒ Ø±Ø§ Ø¨Ù‡â€ŒØ¯Ø±Ø³ØªÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ UTF-8 Ø¨Ø§Ø´Ù†Ø¯.
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†");
        // Ù†ÙˆØ´ØªÙ† ÙØ§ÛŒÙ„
        window.XLSX.writeFile(wb, `${selectedExamName}_Ù†ØªØ§ÛŒØ¬.xlsx`, { bookType: "xlsx", type: "binary" });
    } catch(e) {
        console.error(e);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„");
    }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://egiufeahskfobwhmdbqy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaXVmZWFoc2tmb2J3aG1kYnF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDgzMDksImV4cCI6MjA3NzA4NDMwOX0.3w7G0w5ukLh2B6KU1wfuJJFfOa_HhhGoLFuwUlzSXGw";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</body>
