<!DOCTYPE html>
<html lang="fa" dir="rtl">
<link rel="icon" href="data:,">
<head>
<meta charset="UTF-8">
<title>Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap');
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#c9d6ff,#e2e2e2,#d8bfd8); min-height:100vh; display:flex; align-items:center; justify-content:center; margin:0; color:#333; }
.container { background:#ffffffcc; padding:30px; border-radius:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:650px; text-align:center; }
#exam-section.container {
    width: 90% !important;
    max-width: 900px;
}
button { background:linear-gradient(90deg,#7aa2f7,#b388eb); color:white; border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { transform:scale(1.05); }
.hidden { display:none; }
.role-buttons { display:flex; justify-content:space-around; margin:15px 0; }
input { padding:10px; border-radius:8px; border:1px solid #aaa; width:80%; margin:10px 0; text-align:center; }
.exam-card { background:#f5f5ff; border:2px solid #d0c4f7; border-radius:15px; padding:15px; margin:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.exam-card h3 { color:#4a47a3; margin-bottom:10px; }
.qnum { background:#d0c4f7; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; margin:3px; }
.qnum.active { background:#7aa2f7; color:white; }
.qnum.answered {
    border: 3px solid #7aa2f7;
    background: #eef2ff;
}
.qnum.unanswered {
    opacity: 0.4;
}
.option { display:block; background:#fff; border:1px solid #ccc; padding:8px; margin:8px auto; border-radius:10px; cursor:pointer; width:90%; transition:0.2s; }
.option:hover { background:#e9e9ff; }
#timer { font-size:18px; font-weight:bold; color:#4a47a3; margin:10px; }
#question-box img { width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); margin-bottom:10px; }
.result-table { width:100%; border-collapse:collapse; margin-top:15px; }
.result-table th, .result-table td { border:1px solid #aaa; padding:8px; }
.result-table th { background:#eaeaff; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
.empty { color:#777; font-weight:bold; }
.exam-btn-selected {
    background:#4a6cf7 !important;
    color:white !important;
    border:2px solid #2b4ad8 !important;
}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; color:white; display:none; align-items:center; justify-content:center; flex-direction:column; font-size:22px; z-index:9999;">
    <div id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯... 0%</div>
    <div style="width:60%; background:#fff3; height:10px; border-radius:5px; margin-top:10px;">
        <div id="loading-bar" style="width:0%; height:100%; background:#7aa2f7; border-radius:5px;"></div>
    </div>
    <div style="margin-top:12px; font-size:16px;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</div>
</div>

<body>

<div class="container" id="login-section">
  <h1>ğŸ“  Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø§ÛŒØ±Ù‡</h1>
  <p>Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
  <div class="role-buttons">
    <button id="student-btn">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
    <button id="teacher-btn">Ù…Ø´Ø§ÙˆØ±</button>
  </div>

  <div id="student-form" class="hidden">
    <input type="text" id="student-name" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="text" id="advisor-name" placeholder="Ù†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="text" id="paye" placeholder="Ù¾Ø§ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="text" id="reshte" placeholder="Ø±Ø´ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button id="student-enter">ÙˆØ±ÙˆØ¯</button>
  </div>

  <div id="teacher-form" class="hidden">
    <input type="password" id="teacher-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <button id="teacher-enter">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<div class="container hidden" id="exam-list">
  <h2>ğŸ“ Ø¢Ø²Ù…ÙˆÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
  <div id="exam-container"></div>
</div>

<div class="container hidden" id="exam-section">
  <h2 id="exam-title"></h2>
  <div id="timer"></div>
  <div id="question-box"></div>
  <div>
    <button id="prev-btn">âŸ¨ Ù‚Ø¨Ù„ÛŒ</button>
    <button id="next-btn">Ø¨Ø¹Ø¯ÛŒ âŸ©</button>
  </div>
  <div id="question-list" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
  <br>
  <button id="finish-btn">Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ†</button>
</div>

<div class="container hidden" id="result-section">
  <h2>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¢Ø²Ù…ÙˆÙ†</h2>
  <div id="score-summary"></div>
  <table class="result-table">
    <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø¤Ø§Ù„</th><th>Ù¾Ø§Ø³Ø® Ø´Ù…Ø§</th><th>Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead>
    <tbody id="result-body"></tbody>
  </table>
  <br>
</div>

<div class="container hidden" id="teacher-panel">
  <h2>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h2>
  <h3>ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</h3>
  <div id="teacher-exam-list"></div>
  <br>
  <button id="download-excel" style="margin-bottom:10px;">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„</button>
  <table id="results-table" class="hidden" style="width:100%; border-collapse:collapse;">
    <thead><tr><th>Ù†Ø§Ù…</th><th>Ø¯Ø±ØµØ¯</th><th>ØªØ±Ø§Ø²</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const teacherPassword = "mm2hakdkcnks";
const exams = ["zist1", "shimi_1", "hendese1", "dini", "physics1", "farsi2", "riazi_22_Azar"];

let selectedExam = null, currentQuestion = 0, answers = [], timerInterval, remainingTime, studentName = "";

// Ù†Ù‚Ø´â€ŒÙ‡Ø§
document.getElementById("student-btn").onclick = () => {
  document.getElementById("student-form").classList.remove("hidden");
  document.getElementById("teacher-form").classList.add("hidden");
};
document.getElementById("teacher-btn").onclick = () => {
  document.getElementById("teacher-form").classList.remove("hidden");
  document.getElementById("student-form").classList.add("hidden");
};

// ÙˆØ±ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
document.getElementById("student-enter").onclick = () => {
  studentName = document.getElementById("student-name").value.trim();
  advisorName = document.getElementById("advisor-name").value.trim();
  paye = document.getElementById("paye").value.trim();
  reshte = document.getElementById("reshte").value.trim();

  if (!studentName) return alert("Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  if (!advisorName) return alert("Ù†Ø§Ù… Ù…Ø´Ø§ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  if (!paye) return alert("Ù¾Ø§ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  if (!reshte) return alert("Ø±Ø´ØªÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  document.getElementById("login-section").classList.add("hidden");
  const cont = document.getElementById("exam-container");
  cont.innerHTML = "";
  exams.forEach((name) => {
    const div = document.createElement("div");
    div.className = "exam-card";
    div.innerHTML = `<h3>${name}</h3><button onclick="startExam('${name}')">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>`;
    cont.appendChild(div);
  });
  document.getElementById("exam-list").classList.remove("hidden");
};

// ÙˆØ±ÙˆØ¯ Ù…Ø¹Ù„Ù…
document.getElementById("teacher-enter").onclick = () => {
  if (document.getElementById("teacher-pass").value === teacherPassword) showTeacherPanel();
  else alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
};

// Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† (Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¢Ø²Ù…ÙˆÙ† Ø§Ø² Upload.ir Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§)
window.startExam = async function (examName) {
  selectedExam = examName;
  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("exam-section").classList.remove("hidden");
  document.getElementById("exam-title").innerText = "Ø¢Ø²Ù…ÙˆÙ† " + examName;
  // Ù¾ÛŒØ´ Ø§Ø² Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¢Ø²Ù…ÙˆÙ†ØŒ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø«Ø¨Øª Ú©Ù† (UTC) Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ
  try {
      // Check if a record already exists for this student and exam
      const { data: existing, error: fetchError } = await supabase
          .from('exam_results')
          .select('id')
          .eq('name', studentName)
          .eq('exam', examName)
          .limit(1);

      if (fetchError) throw fetchError;

      // Insert only if no existing record
      if (!existing || existing.length === 0) {
          await supabase
              .from('exam_results')
              .insert([{
                  name: studentName,
                  exam: examName,
                  data: advisorName + " | " + paye + " | " + reshte,
                  created_at: new Date().toISOString()
              }]);
      }
  } catch(e) {
      console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†:", e);
  }
  // GitHub raw links for ZIP files:
  const zipLinks = {
      "zist1": "https://raw.githubusercontent.com/test111account/exam/main/zist1.zip",
      "shimi_1": "https://raw.githubusercontent.com/test111account/exam/main/shimi_1.zip",
      "hendese1": "https://raw.githubusercontent.com/test111account/exam/main/hendese1.zip",
      "dini": "https://raw.githubusercontent.com/test111account/exam/main/dini.zip",
      "physics1": "https://raw.githubusercontent.com/test111account/exam/main/physics1.zip",
      "farsi2": "https://raw.githubusercontent.com/test111account/exam/main/farsi2.zip",
      "riazi_22_Azar": "https://raw.githubusercontent.com/test111account/exam/main/riazi_22_Azar.zip"
  };
  const zipUrl = zipLinks[examName];
  if (!zipUrl) {
    alert("Ù„ÛŒÙ†Ú© Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯!");
    return;
  }
  fetchAndLoadExamZip(zipUrl, examName);
};

// Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ JSZip (Ø¨Ø§ fetch Ùˆ CORS)
async function fetchAndLoadExamZip(zipUrl, examName) {
  try {
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
    document.getElementById("loading-overlay").style.display = "flex";
    // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¨Ø§ Ù¾ÛŒØ´Ø±ÙØª
    const resp = await fetch(zipUrl);
    if (!resp.ok) throw new Error("Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.");

    const contentLength = resp.headers.get("Content-Length");
    const total = contentLength ? parseInt(contentLength) : 0;
    let received = 0;

    const reader = resp.body.getReader();
    const chunks = [];

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (total > 0) {
            const percent = Math.floor((received / total) * 100);
            document.getElementById("loading-text").innerText = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯... ${percent}%`;
            document.getElementById("loading-bar").style.width = percent + "%";
        }
    }

    const zipBlob = new Blob(chunks);
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø§ JSZip
    const jszip = window.JSZip;
    const zipData = await zipBlob.arrayBuffer();
    const zip = await jszip.loadAsync(zipData);

    // Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ†
    let duration = 300;
    if (zip.file("time.txt")) {
      const timeText = await zip.file("time.txt").async("string");
      duration = parseInt(timeText.trim()) || 300;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³ÙˆØ§Ù„Ø§Øª: Ù‡Ø± Ø³ÙˆØ§Ù„ ÛŒÚ© Ø¹Ú©Ø³ Ø¨Ù‡ ØµÙˆØ±Øª 1-1.jpg ÛŒØ§ 1-1.png ... 50-4.jpg/pngØŒ Ú¯Ø²ÛŒÙ†Ù‡ ØµØ­ÛŒØ­ Ø§ÙˆÙ„ÛŒÙ† Ø¹Ú©Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
    const imgList = [];
    for (let i = 1; i <= 50; i++) {
      let found = false;
      for (let j = 1; j <= 4; j++) {
        const exts = ["jpg", "png", "PNG", "JPG"];
        for (const ext of exts) {
          const fname = `${i}-${j}.${ext}`;
          const fileObj = zip.file(fname);
          if (fileObj) {
            const blob = await fileObj.async("blob");
            const url = URL.createObjectURL(blob);
            imgList.push({ id: i, src: url, correct: j });
            found = true;
            break;
          }
        }
        if (found) break;
      }
      if (!found) break;
    }
    if (imgList.length === 0) {
      alert("Ù‡ÛŒÚ† ØªØµÙˆÛŒØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø²ÛŒÙ¾ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
      document.getElementById("loading-overlay").style.display = "none";
      return;
    }
    // Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡ PDF
    let answerkeyPdfUrl = "#";
    if (zip.file("answerkey.pdf")) {
      const pdfBlob = await zip.file("answerkey.pdf").async("blob");
      answerkeyPdfUrl = URL.createObjectURL(pdfBlob);
    }
    document.getElementById("loading-overlay").style.display = "none";
    showExam(imgList, duration, examName, answerkeyPdfUrl);
  } catch (e) {
    document.getElementById("loading-overlay").style.display = "none";
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø¢Ø²Ù…ÙˆÙ†");
    console.error(e);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†
function showExam(questions, duration, folder, answerkeyPdfUrl) {
  selectedExam = { folder, questions, duration_sec: duration, answerkeyPdfUrl };
  answers = new Array(questions.length).fill(null);
  currentQuestion = 0;
  renderQuestion();
  renderQList();
  startTimer(duration);
  document.getElementById("prev-btn").style.display = "";
  document.getElementById("next-btn").style.display = "";
  document.getElementById("finish-btn").style.display = "";
  document.getElementById("question-list").style.display = "flex";
}

// Ù†Ù…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„
function renderQuestion() {
  const q = selectedExam.questions[currentQuestion];
  const box = document.getElementById("question-box");
  box.innerHTML = `<img src="${q.src}" alt="question">`;
  for (let i = 1; i <= 4; i++) {
    const div = document.createElement("div");
    div.className = "option";
    if (answers[currentQuestion] === i) div.style.background = "#d0c4f7";
    div.innerText = `Ú¯Ø²ÛŒÙ†Ù‡ ${i}`;
    div.onclick = () => {
      if (answers[currentQuestion] === i) {
        answers[currentQuestion] = null; // Deselect if the same option is clicked
      } else {
        answers[currentQuestion] = i; // Select new option
      }
      renderQuestion();
      renderQList();
    };
    box.appendChild(div);
  }
  document.querySelectorAll(".qnum").forEach((e, i) => {
      e.classList.remove("active");
      if (i === currentQuestion) e.classList.add("active");
  });
}

// Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„Ø§Øª
document.getElementById("next-btn").onclick = () => { if (currentQuestion < selectedExam.questions.length - 1) { currentQuestion++; renderQuestion(); } };
document.getElementById("prev-btn").onclick = () => { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } };

// Ù„ÛŒØ³Øª Ø³Ø¤Ø§Ù„Ø§Øª Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡
function renderQList() {
  const list = document.getElementById("question-list"); list.innerHTML = "";
  selectedExam.questions.forEach((_, i) => {
    const b = document.createElement("div");
    b.className = "qnum"; b.innerText = i + 1;
    if (answers[i] != null) {
        b.classList.add("answered");
    } else {
        b.classList.add("unanswered");
    }

    if (i === currentQuestion) {
        b.classList.add("active");
    }

    b.onclick = () => { currentQuestion = i; renderQuestion(); };
    list.appendChild(b);
  });
}

// ØªØ§ÛŒÙ…Ø±
function startTimer(sec) {
  remainingTime = sec;
  const timer = document.getElementById("timer");
  timerInterval = setInterval(() => {
    remainingTime--;
    const m = Math.floor(remainingTime / 60), s = remainingTime % 60;
    timer.innerText = `â° ${m}:${s.toString().padStart(2, '0')}`;
    if (remainingTime <= 0) { clearInterval(timerInterval); finishExam(); }
  }, 1000);
}

document.getElementById("finish-btn").onclick = finishExam;

// Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ (Supabase Only, Ø±ØªØ¨Ù‡ Ùˆ ØªØ±Ø§Ø² ØµØ­ÛŒØ­ Ø¨Ø§ Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ)
let isSavingResult = false;

async function finishExam() {
  if (isSavingResult) return; // prevent multiple clicks
  isSavingResult = true;
  clearInterval(timerInterval);

  let correct = 0, wrong = 0, empty = 0;
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    if (ans == null) empty++;
    else if (ans === q.correct) correct++;
    else wrong++;
  });

  // Ù†Ù…Ø±Ù‡ Ø¨Ø§ Ù…Ù†ÙÛŒ
  const rawScore = correct - wrong / 3;
  const totalQuestions = selectedExam.questions.length;
  const percentScore = (rawScore / totalQuestions) * 100;

  // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  let allScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, score, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allScores = data.map(r => ({ name: r.name, score: r.score, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ùˆ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø± Ø¯Ø±ØµØ¯Ù‡Ø§
  const percentList = allScores.map(r => Number(r.score)).filter(x => !isNaN(x));
  percentList.push(percentScore); // Ø¯Ø±ØµØ¯ ÙØ¹Ù„ÛŒ Ø±Ø§ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† (ØªØ§ Ø¯Ø± Ø¬Ù…Ø¹ Ù„Ø­Ø§Ø¸ Ø´ÙˆØ¯)
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
  const mean = percentList.length > 0 ? percentList.reduce((a, b) => a + b, 0) / percentList.length : 50;
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø­Ø±Ø§Ù Ù…Ø¹ÛŒØ§Ø±
  let stdDev = 10;
  if (percentList.length > 1) {
    const variance = percentList.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / percentList.length;
    stdDev = Math.sqrt(variance);
    // Ø§Ú¯Ø± stdDev Ø®ÛŒÙ„ÛŒ Ú©Ù… Ø´Ø¯ØŒ Ø­Ø¯Ø§Ù‚Ù„ 5 Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ØªØ§ ØªØ±Ø§Ø² Ù…Ø¹Ù†Ø§Ø¯Ø§Ø± Ø¨Ù…Ø§Ù†Ø¯
    if (stdDev < 5) stdDev = 5;
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ
  const tScore = 5000 + 1000 * (percentScore - mean) / stdDev;

  // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ÙØ¹Ù„ÛŒ Ø¯Ø± Supabase (Ø¨Ø§ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±ÛŒ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ú©ÙˆØ±Ø¯ Ù†Ø§Ù‚Øµ)
  try {
      // Check for existing record with same student, advisor, and paye
      const { data: existing, error: fetchError } = await supabase
          .from('exam_results')
          .select('id, score')
          .eq('name', studentName)
          .eq('exam', selectedExam.folder)
          .eq('data', advisorName + " | " + paye + " | " + reshte)
          .limit(1);

      if (fetchError) throw fetchError;

      if (existing && existing.length > 0 && (existing[0].score === null || existing[0].score === undefined)) {
          // Update the existing record
          await supabase
            .from('exam_results')
            .update({
              score: percentScore,
              tScore: tScore,
              created_at: new Date().toISOString()
            })
            .eq('id', existing[0].id);
      } else if (!existing || existing.length === 0) {
          // Insert new record if none exists
          await supabase
            .from('exam_results')
            .insert([{
              name: studentName,
              exam: selectedExam.folder,
              score: percentScore,
              tScore: tScore,
              data: advisorName + " | " + paye + " | " + reshte,
              created_at: new Date().toISOString()
            }]);
      }
  } catch (error) {
      console.error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡:", error);
  } finally {
      isSavingResult = false;
  }

  // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬Ø¯Ø¯ Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
  let allTScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allTScores = data.map(r => ({ name: r.name, tScore: r.tScore }));
  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬:", error);
  }

  // Dense Ranking ÙˆØ§Ù‚Ø¹ÛŒ:
  // 1. Ù‡Ù…Ù‡ ØªØ±Ø§Ø²Ù‡Ø§ Ø±Ø§ Ù†Ø²ÙˆÙ„ÛŒ Ù…Ø±ØªØ¨ Ú©Ù†
  // 2. Ø±ØªØ¨Ù‡ Ù‡Ø± ØªØ±Ø§Ø² Ø±Ø§ Ø¯Ø± ÛŒÚ© Map Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
  // 3. Ø±ØªØ¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² = Ù…Ù‚Ø¯Ø§Ø± Map Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ø² Ø®ÙˆØ¯Ø´
  const tScoresSorted = allTScores
    .map(r => Number(r.tScore))
    .filter(x => !isNaN(x));
  tScoresSorted.sort((a, b) => b - a);
  const tScoreToRank = new Map();
  let rank = 1;
  for (let i = 0; i < tScoresSorted.length; i++) {
    const ts = tScoresSorted[i];
    if (!tScoreToRank.has(ts)) {
      tScoreToRank.set(ts, rank);
      rank++;
    }
  }
  const myRank = tScoreToRank.has(tScore) ? tScoreToRank.get(tScore) : tScoresSorted.length;
  const totalParticipants = tScoresSorted.length;

  // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.remove("hidden");

  document.getElementById("score-summary").innerHTML = `
    <p>ğŸ¯ Ø¯Ø±ØµØ¯ Ù†Ù…Ø±Ù‡: <b>${percentScore.toFixed(2)}%</b></p>
    <p>âœ… Ø¯Ø±Ø³Øª: ${correct} | âŒ ØºÙ„Ø·: ${wrong} | âº Ù†Ø²Ø¯Ù‡: ${empty}</p>
  `;

  const tbody = document.getElementById("result-body");
  tbody.innerHTML = "";
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    let statusClass = "", statusText = "";
    if (ans == null) { statusClass = "empty"; statusText = "Ù†Ø²Ø¯Ù‡"; }
    else if (ans === q.correct) { statusClass = "correct"; statusText = "Ø¯Ø±Ø³Øª"; }
    else { statusClass = "wrong"; statusText = "ØºÙ„Ø·"; }

    const row = `<tr>
      <td>${i + 1}</td>
      <td>${ans ? ans : "-"}</td>
      <td>${q.correct}</td>
      <td class="${statusClass}">${statusText}</td>
    </tr>`;
    tbody.innerHTML += row;
  });


  // ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± PDF Ø§Ø² Ø¨Ø®Ø´ Ù†ØªÛŒØ¬Ù‡ Ù¾Ø³ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ú†Ù†Ø¯ ØµÙØ­Ù‡)
  setTimeout(async () => {
      try {
          const resultSection = document.getElementById("result-section");
          const canvas = await html2canvas(resultSection, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/png");

          const pdf = new jspdf.jsPDF({
              orientation: "portrait",
              unit: "pt",
              format: "a4"
          });

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = pageWidth - 40;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          let remainingHeight = imgHeight;
          let positionY = 20;

          pdf.addImage(imgData, "PNG", 20, positionY, imgWidth, imgHeight);

          while (remainingHeight > pageHeight - 40) {
              pdf.addPage();
              remainingHeight -= (pageHeight - 40);
              positionY = 20 - remainingHeight;
              pdf.addImage(imgData, "PNG", 20, positionY, imgWidth, imgHeight);
          }

          pdf.save(`Ú¯Ø²Ø§Ø±Ø´_Ø¢Ø²Ù…ÙˆÙ†_${studentName}.pdf`);
      } catch (e) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF:", e);
      }
  }, 1000);
}

// Ø­Ø°Ù Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± localStorage (Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù… (Supabase)
function showTeacherPanel() {
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("teacher-panel").classList.remove("hidden");
  const list = document.getElementById("teacher-exam-list");
  list.innerHTML = "";
  const resultsTable = document.getElementById("results-table");
  resultsTable.classList.add("hidden"); // hide initially

  exams.forEach(ex => {
      const btn = document.createElement("button");
      btn.style.margin = "5px";
      btn.innerText = ex;
      btn.onclick = () => {
          // Remove highlight from all buttons
          document.querySelectorAll("#teacher-exam-list button").forEach(b => b.classList.remove("exam-btn-selected"));
          // Highlight the selected button
          btn.classList.add("exam-btn-selected");
          // Show the results table
          resultsTable.classList.remove("hidden");
          loadTeacherResults(ex);
      };
      list.appendChild(btn);
  });
}

// Ù„ÙˆØ¯ Ù†ØªØ§ÛŒØ¬ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø§Ø² Supabase Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø«Ø¨Øª Ùˆ Ø³ØªÙˆÙ† ØªØ±Ø§Ø²
async function loadTeacherResults(selectedExamName = null) {
  const tbody = document.querySelector("#teacher-panel tbody");
  tbody.innerHTML = "";
  document.getElementById("results-table").classList.remove("hidden");
  try {
    let query = supabase
      .from('exam_results')
      .select('name, exam, score, created_at, data');
    if (selectedExamName) query = query.eq('exam', selectedExamName);
    const { data, error } = await query;
    // Debug: Print all received data and error
    console.log("Supabase data received:", data, "Error:", error);
    if (error) throw error;

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø² Ú©Ù†Ú©ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ø§Øª ÙØ¹Ù„ÛŒ
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ÙÙ‚Ø· Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†Ù…Ø±Ù‡ Ø¯Ø§Ø±Ù†Ø¯ (null Ù†Ø¨Ø§Ø´Ø¯)
    const validScores = data.filter(r => r.score !== null && r.score !== undefined);
    const percentList = validScores.map(r => Number(r.score)).filter(x => !isNaN(x));
    // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ù†Ø¨ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ±)
    const mean = percentList.length > 0 ? percentList.reduce((a, b) => a + b, 0) / percentList.length : 50;
    let stdDev = 10;
    if (percentList.length > 1) {
      const variance = percentList.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / percentList.length;
      stdDev = Math.sqrt(variance);
      if (stdDev < 5) stdDev = 5;
    }

    // sort descending by score
    data.sort((a, b) => (b.score || 0) - (a.score || 0));
    data.forEach(r => {
        // Debug: Print each record to inspect column names and values
        console.log("Record:", r); // Print each record to inspect column names and values

        let dateStr = "-";
        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø¨Ù‡ ÙˆÙ‚Øª Ø§ÛŒØ±Ø§Ù† (UTC+3:30)
        if (r.created_at) {
            try {
                const d = new Date(r.created_at); // UTC time
                // Convert to Iran local time by adding 3.5 hours
                const iranTime = new Date(d.getTime() + (3.5 * 60 * 60 * 1000));
                const y = iranTime.getFullYear();
                const m = String(iranTime.getMonth() + 1).padStart(2, '0');
                const day = String(iranTime.getDate()).padStart(2, '0');
                const hour = String(iranTime.getHours()).padStart(2, '0');
                const min = String(iranTime.getMinutes()).padStart(2, '0');
                dateStr = `${y}/${m}/${day} ${hour}:${min}`;
            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø§ÛŒØ±Ø§Ù†:", e);
            }
        }

        const scoreDisplay = r.score != null ? Number(r.score).toFixed(2) : "-";
        // ØªØ±Ø§Ø² Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† (Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…ÙˆÙ„)
        let tScoreDisplay = "-";
        if (r.score !== null && r.score !== undefined && !isNaN(Number(r.score))) {
          const tScoreCalc = 5000 + 1000 * ((Number(r.score) - mean) / stdDev);
          tScoreDisplay = tScoreCalc.toFixed(2);
        }

        const row = document.createElement("tr");
        const info = r.data || "";
        row.innerHTML = `
            <td>${r.name}<br><span style="font-size:10px;color:#666">${info}</span></td>
            <td>${scoreDisplay}%</td>
            <td>${tScoreDisplay}</td>
            <td>${dateStr}</td>
        `;
        tbody.appendChild(row);
    });
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬</td></tr>`;
    console.error(e);
  }
}
// Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ (CSV)
document.getElementById("download-excel").onclick = async () => {
    const selectedExamName = document.querySelector("#teacher-exam-list button.exam-btn-selected")?.innerText;
    if (!selectedExamName) return alert("ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");

    try {
        const { data, error } = await supabase
            .from('exam_results')
            .select('name, score, created_at, data')
            .eq('exam', selectedExamName);
        if (error) throw error;
        if (!data || data.length === 0) return alert("Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");

        // ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù† Ø¨Ù‡ Ø§ÛŒØ±Ø§Ù† Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø²
        const validScores = data.filter(r => r.score !== null && r.score !== undefined);
        const percentList = validScores.map(r => Number(r.score)).filter(x => !isNaN(x));
        const mean = percentList.length > 0 ? percentList.reduce((a,b)=>a+b,0)/percentList.length : 50;
        let stdDev = 10;
        if (percentList.length > 1) {
            const variance = percentList.reduce((sum,x)=>sum+Math.pow(x-mean,2),0)/percentList.length;
            stdDev = Math.sqrt(variance);
            if (stdDev < 5) stdDev = 5;
        }

        // sort descending by score
        data.sort((a,b)=> (b.score || 0) - (a.score || 0));

        const rows = data.map(r => {
            let dateStr = "-";
            if (r.created_at) {
                const d = new Date(r.created_at);
                const iranTime = new Date(d.getTime() + (3.5*60*60*1000));
                const y = iranTime.getFullYear();
                const m = String(iranTime.getMonth()+1).padStart(2,'0');
                const day = String(iranTime.getDate()).padStart(2,'0');
                const hour = String(iranTime.getHours()).padStart(2,'0');
                const min = String(iranTime.getMinutes()).padStart(2,'0');
                dateStr = `${y}/${m}/${day} ${hour}:${min}`;
            }
            const score = r.score != null ? Number(r.score).toFixed(2) : "-";
            const tScoreCalc = (r.score != null && !isNaN(Number(r.score))) ? 5000 + 1000 * ((Number(r.score)-mean)/stdDev) : "-";
            return {
                "Ù†Ø§Ù…": r.name,
                "Ù¾Ø§ÛŒÙ‡ | Ø±Ø´ØªÙ‡ | Ù…Ø´Ø§ÙˆØ±": r.data || "",
                "Ø¯Ø±ØµØ¯": score,
                "ØªØ±Ø§Ø²": tScoreCalc !== "-" ? tScoreCalc.toFixed(2) : "-",
                "ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª": dateStr
            };
        });

        // Ø§ÛŒØ¬Ø§Ø¯ CSV
        const csvHeader = Object.keys(rows[0]).join(",") + "\n";
        const csvBody = rows.map(r => Object.values(r).map(v=>`"${v}"`).join(",")).join("\n");
        const csvContent = csvHeader + csvBody;

        const blob = new Blob([csvContent], { type:"text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${selectedExamName}_Ù†ØªØ§ÛŒØ¬.csv`;
        link.click();
    } catch(e) {
        console.error(e);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„");
    }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://egiufeahskfobwhmdbqy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaXVmZWFoc2tmb2J3aG1kYnF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDgzMDksImV4cCI6MjA3NzA4NDMwOX0.3w7G0w5ukLh2B6KU1wfuJJFfOa_HhhGoLFuwUlzSXGw";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</body>
</html>
