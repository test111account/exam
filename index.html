<!DOCTYPE html>
<html lang="fa" dir="rtl">
<link rel="icon" href="data:,">
<head>
<meta charset="UTF-8">
<title>آزمون دایره</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap');
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#c9d6ff,#e2e2e2,#d8bfd8); min-height:100vh; display:flex; align-items:center; justify-content:center; margin:0; color:#333; }
.container { background:#ffffffcc; padding:30px; border-radius:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:520px; text-align:center; }
button { background:linear-gradient(90deg,#7aa2f7,#b388eb); color:white; border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { transform:scale(1.05); }
.hidden { display:none; }
.role-buttons { display:flex; justify-content:space-around; margin:15px 0; }
input { padding:10px; border-radius:8px; border:1px solid #aaa; width:80%; margin:10px 0; text-align:center; }
.exam-card { background:#f5f5ff; border:2px solid #d0c4f7; border-radius:15px; padding:15px; margin:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.exam-card h3 { color:#4a47a3; margin-bottom:10px; }
.qnum { background:#d0c4f7; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; margin:3px; }
.qnum.active { background:#7aa2f7; color:white; }
.option { display:block; background:#fff; border:1px solid #ccc; padding:8px; margin:8px auto; border-radius:10px; cursor:pointer; width:90%; transition:0.2s; }
.option:hover { background:#e9e9ff; }
#timer { font-size:18px; font-weight:bold; color:#4a47a3; margin:10px; }
#question-box img { width:100%; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); margin-bottom:10px; }
.result-table { width:100%; border-collapse:collapse; margin-top:15px; }
.result-table th, .result-table td { border:1px solid #aaa; padding:8px; }
.result-table th { background:#eaeaff; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
.empty { color:#777; font-weight:bold; }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container" id="login-section">
  <h1>🎓  آزمون دایره</h1>
  <p>نقش خود را انتخاب کنید:</p>
  <div class="role-buttons">
    <button id="student-btn">دانش‌آموز</button>
    <button id="teacher-btn">مشاور</button>
  </div>

  <div id="student-form" class="hidden">
    <input type="text" id="student-name" placeholder="نام خود را وارد کنید">
    <button id="student-enter">ورود</button>
  </div>

  <div id="teacher-form" class="hidden">
    <input type="password" id="teacher-pass" placeholder="رمز عبور را وارد کنید">
    <button id="teacher-enter">ورود</button>
  </div>
</div>

<div class="container hidden" id="exam-list">
  <h2>📝 آزمون خود را انتخاب کنید</h2>
  <div id="exam-container"></div>
</div>

<div class="container hidden" id="exam-section">
  <h2 id="exam-title"></h2>
  <div id="timer"></div>
  <div id="question-box"></div>
  <div>
    <button id="prev-btn">⟨ قبلی</button>
    <button id="next-btn">بعدی ⟩</button>
  </div>
  <div id="question-list" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
  <br>
  <button id="finish-btn">پایان آزمون</button>
</div>

<div class="container hidden" id="result-section">
  <h2>📋 گزارش آزمون</h2>
  <div id="score-summary"></div>
  <table class="result-table">
    <thead><tr><th>شماره سؤال</th><th>پاسخ شما</th><th>پاسخ صحیح</th><th>وضعیت</th></tr></thead>
    <tbody id="result-body"></tbody>
  </table>
  <br>
  <a id="answerkey-link" href="#" download><button>📘 دانلود پاسخ‌نامه</button></a>
</div>

<div class="container hidden" id="teacher-panel">
  <h2>📊 نتایج آزمون‌ها</h2>
  <table id="results-table" style="width:100%; border-collapse:collapse;">
    <thead><tr><th>نام</th><th>آزمون</th><th>درصد</th><th>تاریخ</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const teacherPassword = "mm2hakdkcnks";
const exams = ["10-1-r", "11-1-r"];

let selectedExam = null, currentQuestion = 0, answers = [], timerInterval, remainingTime, studentName = "";

// نقش‌ها
document.getElementById("student-btn").onclick = () => {
  document.getElementById("student-form").classList.remove("hidden");
  document.getElementById("teacher-form").classList.add("hidden");
};
document.getElementById("teacher-btn").onclick = () => {
  document.getElementById("teacher-form").classList.remove("hidden");
  document.getElementById("student-form").classList.add("hidden");
};

// ورود دانش‌آموز
document.getElementById("student-enter").onclick = () => {
  studentName = document.getElementById("student-name").value.trim();
  if (!studentName) return alert("نام را وارد کنید");
  document.getElementById("login-section").classList.add("hidden");
  const cont = document.getElementById("exam-container");
  cont.innerHTML = "";
  exams.forEach((name) => {
    const div = document.createElement("div");
    div.className = "exam-card";
    div.innerHTML = `<h3>${name}</h3><button onclick="startExam('${name}')">شروع آزمون</button>`;
    cont.appendChild(div);
  });
  document.getElementById("exam-list").classList.remove("hidden");
};

// ورود معلم
document.getElementById("teacher-enter").onclick = () => {
  if (document.getElementById("teacher-pass").value === teacherPassword) showTeacherPanel();
  else alert("رمز اشتباه است!");
};

// شروع آزمون (دانلود و استخراج فایل زیپ آزمون از Upload.ir با پشتیبانی کامل موبایل و مرورگرها)
window.startExam = function (examName) {
  selectedExam = examName;
  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("exam-section").classList.remove("hidden");
  document.getElementById("exam-title").innerText = "آزمون " + examName;
  // GitHub raw links for ZIP files:
  const zipLinks = {
    "10-1-r": "https://raw.githubusercontent.com/test111account/exam/fcd28a9e0e4d7eaf06cffc160f3ddc20a60ce96d/10-1-r.zip",
    "11-1-r": "https://raw.githubusercontent.com/test111account/exam/fcd28a9e0e4d7eaf06cffc160f3ddc20a60ce96d/11-1-r.zip"
  };
  const zipUrl = zipLinks[examName];
  if (!zipUrl) {
    alert("لینک آزمون یافت نشد!");
    return;
  }
  fetchAndLoadExamZip(zipUrl, examName);
};

// دانلود فایل زیپ و استخراج داده‌ها با JSZip (با fetch و CORS)
async function fetchAndLoadExamZip(zipUrl, examName) {
  try {
    // دانلود فایل زیپ با fetch و blob (CORS-safe)
    const resp = await fetch(zipUrl, { mode: 'cors' });
    if (!resp.ok) throw new Error("دانلود فایل زیپ انجام نشد.");
    const zipBlob = await resp.blob();
    // استخراج با JSZip
    const jszip = window.JSZip;
    const zipData = await zipBlob.arrayBuffer();
    const zip = await jszip.loadAsync(zipData);

    // زمان آزمون
    let duration = 300;
    if (zip.file("time.txt")) {
      const timeText = await zip.file("time.txt").async("string");
      duration = parseInt(timeText.trim()) || 300;
    }

    // استخراج سوالات: هر سوال یک عکس به صورت 1-1.jpg ... 50-4.jpg، گزینه صحیح اولین عکس موجود است
    const imgList = [];
    for (let i = 1; i <= 50; i++) {
      let found = false;
      for (let j = 1; j <= 4; j++) {
        const fname = `${i}-${j}.jpg`;
        const fileObj = zip.file(fname);
        if (fileObj) {
          const blob = await fileObj.async("blob");
          const url = URL.createObjectURL(blob);
          imgList.push({ id: i, src: url, correct: j });
          found = true;
          break;
        }
      }
      if (!found) break;
    }
    if (imgList.length === 0) {
      alert("هیچ تصویری در این زیپ یافت نشد!");
      return;
    }
    // پاسخنامه PDF
    let answerkeyPdfUrl = "#";
    if (zip.file("answerkey.pdf")) {
      const pdfBlob = await zip.file("answerkey.pdf").async("blob");
      answerkeyPdfUrl = URL.createObjectURL(pdfBlob);
    }
    showExam(imgList, duration, examName, answerkeyPdfUrl);
  } catch (e) {
    alert("خطا در بارگذاری فایل زیپ آزمون");
    console.error(e);
  }
}

// نمایش آزمون
function showExam(questions, duration, folder, answerkeyPdfUrl) {
  selectedExam = { folder, questions, duration_sec: duration, answerkeyPdfUrl };
  answers = new Array(questions.length).fill(null);
  currentQuestion = 0;
  renderQuestion();
  renderQList();
  startTimer(duration);
  document.getElementById("prev-btn").style.display = "";
  document.getElementById("next-btn").style.display = "";
  document.getElementById("finish-btn").style.display = "";
  document.getElementById("question-list").style.display = "flex";
}

// نمایش سؤال
function renderQuestion() {
  const q = selectedExam.questions[currentQuestion];
  const box = document.getElementById("question-box");
  box.innerHTML = `<img src="${q.src}" alt="question">`;
  for (let i = 1; i <= 4; i++) {
    const div = document.createElement("div");
    div.className = "option";
    if (answers[currentQuestion] === i) div.style.background = "#d0c4f7";
    div.innerText = `گزینه ${i}`;
    div.onclick = () => {
      // Allow toggling off selection (set to null if clicked again)
      if (answers[currentQuestion] === i) {
        answers[currentQuestion] = null;
      } else {
        answers[currentQuestion] = i;
      }
      renderQuestion();
      renderQList();
    };
    box.appendChild(div);
  }
  document.querySelectorAll(".qnum").forEach((e, i) => { e.classList.toggle("active", i === currentQuestion); });
}

// پیمایش سؤالات
document.getElementById("next-btn").onclick = () => { if (currentQuestion < selectedExam.questions.length - 1) { currentQuestion++; renderQuestion(); } };
document.getElementById("prev-btn").onclick = () => { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } };

// لیست سؤالات پایین صفحه
function renderQList() {
  const list = document.getElementById("question-list"); list.innerHTML = "";
  selectedExam.questions.forEach((_, i) => {
    const b = document.createElement("div");
    b.className = "qnum"; b.innerText = i + 1;
    if (answers[i] != null) b.style.opacity = "1";
    b.onclick = () => { currentQuestion = i; renderQuestion(); };
    list.appendChild(b);
  });
}

// تایمر
function startTimer(sec) {
  remainingTime = sec;
  const timer = document.getElementById("timer");
  timerInterval = setInterval(() => {
    remainingTime--;
    const m = Math.floor(remainingTime / 60), s = remainingTime % 60;
    timer.innerText = `⏰ ${m}:${s.toString().padStart(2, '0')}`;
    if (remainingTime <= 0) { clearInterval(timerInterval); finishExam(); }
  }, 1000);
}

document.getElementById("finish-btn").onclick = finishExam;

// پایان آزمون و ذخیره نتیجه (Supabase Only, رتبه و تراز صحیح با Dense Ranking واقعی)
async function finishExam() {
  clearInterval(timerInterval);

  let correct = 0, wrong = 0, empty = 0;
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    if (ans == null) empty++;
    else if (ans === q.correct) correct++;
    else wrong++;
  });

  // نمره با منفی
  const rawScore = correct - wrong / 3;
  const totalQuestions = selectedExam.questions.length;
  const percentScore = (rawScore / totalQuestions) * 100;

  // محاسبه تراز (مثال ساده: 1000 + 10*(score-50))
  const tScore = 1000 + (percentScore - 50) * 10;

  // ذخیره نتیجه فعلی در Supabase
  try {
    await supabase
      .from('exam_results')
      .insert([{
        name: studentName,
        exam: selectedExam.folder,
        score: percentScore,
        tScore: tScore,
        created_at: new Date().toISOString() // ensure timestamp is set
      }]);
  } catch (error) {
    console.error("خطا در ذخیره نتیجه:", error);
  }

  // دریافت همه نتایج برای محاسبه رتبه صحیح (Dense Ranking واقعی)
  let allScores = [];
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, tScore')
      .eq('exam', selectedExam.folder);
    if (error) throw error;
    allScores = data.map(r => ({ name: r.name, tScore: r.tScore }));
  } catch (error) {
    console.error("خطا در دریافت نتایج:", error);
  }

  // Dense Ranking واقعی:
  // 1. همه ترازها را نزولی مرتب کن
  // 2. رتبه هر تراز را در یک Map ذخیره کن
  // 3. رتبه دانش‌آموز = مقدار Map برای تراز خودش
  const tScoresSorted = allScores
    .map(r => Number(r.tScore))
    .filter(x => !isNaN(x));
  tScoresSorted.sort((a, b) => b - a);
  const tScoreToRank = new Map();
  let rank = 1;
  for (let i = 0; i < tScoresSorted.length; i++) {
    const ts = tScoresSorted[i];
    if (!tScoreToRank.has(ts)) {
      tScoreToRank.set(ts, rank);
      rank++;
    }
  }
  const myRank = tScoreToRank.has(tScore) ? tScoreToRank.get(tScore) : tScoresSorted.length;
  const totalParticipants = tScoresSorted.length;

  // نمایش نتیجه
  document.getElementById("exam-section").classList.add("hidden");
  document.getElementById("result-section").classList.remove("hidden");

  document.getElementById("score-summary").innerHTML = `
    <p>🎯 درصد نمره: <b>${percentScore.toFixed(2)}%</b></p>
    <p>📊 تراز: <b>${tScore.toFixed(2)}</b></p>
    <p>🏆 رتبه: نفر <b>${myRank}</b> از <b>${totalParticipants}</b> نفر</p>
    <p>✅ درست: ${correct} | ❌ غلط: ${wrong} | ⏺ نزده: ${empty}</p>
  `;

  const tbody = document.getElementById("result-body");
  tbody.innerHTML = "";
  selectedExam.questions.forEach((q, i) => {
    const ans = answers[i];
    let statusClass = "", statusText = "";
    if (ans == null) { statusClass = "empty"; statusText = "نزده"; }
    else if (ans === q.correct) { statusClass = "correct"; statusText = "درست"; }
    else { statusClass = "wrong"; statusText = "غلط"; }

    const row = `<tr>
      <td>${i + 1}</td>
      <td>${ans ? ans : "-"}</td>
      <td>${q.correct}</td>
      <td class="${statusClass}">${statusText}</td>
    </tr>`;
    tbody.innerHTML += row;
  });

  // لینک دانلود پاسخنامه PDF
  const link = document.getElementById("answerkey-link");
  if (selectedExam.answerkeyPdfUrl) {
    link.href = selectedExam.answerkeyPdfUrl;
    link.download = "answerkey.pdf";
  } else {
    link.href = "#";
    link.download = "";
  }

  // تولید خودکار PDF از بخش نتیجه پس از نمایش
  setTimeout(async () => {
      try {
          const resultSection = document.getElementById("result-section");
          const canvas = await html2canvas(resultSection, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jspdf.jsPDF({
              orientation: "portrait",
              unit: "pt",
              format: "a4"
          });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = pageWidth - 40;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          pdf.addImage(imgData, "PNG", 20, 20, imgWidth, imgHeight);
          pdf.save(`گزارش_آزمون_${studentName}.pdf`);
      } catch (e) {
          console.error("خطا در ساخت PDF:", e);
      }
  }, 1000);
}

// حذف ذخیره نتایج در localStorage (دیگر استفاده نمی‌شود)

// نمایش پنل معلم (Supabase)
function showTeacherPanel() {
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("teacher-panel").classList.remove("hidden");
  loadTeacherResults();
}

// لود نتایج ذخیره‌شده از Supabase با نمایش تاریخ و ساعت ثبت و ستون تراز
async function loadTeacherResults() {
  const tbody = document.querySelector("#teacher-panel tbody");
  tbody.innerHTML = "";
  try {
    const { data, error } = await supabase
      .from('exam_results')
      .select('name, exam, score, tScore, created_at');
    // Debug: Print all received data and error
    console.log("Supabase data received:", data, "Error:", error);
    if (error) throw error;

    data.forEach(r => {
        // Debug: Print each record to inspect column names and values
        console.log("Record:", r); // Print each record to inspect column names and values

        let dateStr = "-";
        // Fallback: check for created_at property
        if (r.created_at) { // fallback check
            try {
                const d = new Date(r.created_at);
                if (!isNaN(d)) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hour = String(d.getHours()).padStart(2, '0');
                    const min = String(d.getMinutes()).padStart(2, '0');
                    dateStr = `${y}/${m}/${day} ${hour}:${min}`;
                }
            } catch (e) {
                console.error("خطا در تبدیل تاریخ:", e);
            }
        }

        const scoreDisplay = r.score != null ? r.score.toFixed(2) : "-";
        const tScoreDisplay = r.tScore != null ? r.tScore.toFixed(2) : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${r.name}</td>
            <td>${r.exam}</td>
            <td>${scoreDisplay}%<br><span style="font-size:11px;color:#666">تراز: ${tScoreDisplay}</span></td>
            <td>${dateStr}</td>
        `;
        tbody.appendChild(row);
    });
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4">خطا در دریافت نتایج</td></tr>`;
    console.error(e);
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://egiufeahskfobwhmdbqy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaXVmZWFoc2tmb2J3aG1kYnF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDgzMDksImV4cCI6MjA3NzA4NDMwOX0.3w7G0w5ukLh2B6KU1wfuJJFfOa_HhhGoLFuwUlzSXGw";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</body>
</html>
